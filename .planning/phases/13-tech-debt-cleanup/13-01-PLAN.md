---
phase: 13-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/astrology_calc.py
autonomous: true

must_haves:
  truths:
    - "chart.json meta object includes a slug field matching the profile directory name"
    - "--save flag works with --timeline mode, saving timeline snapshot to profile directory"
    - "SKILL.md routing table accurately reflects which modes support --save"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "meta.slug field in build_chart_json() and --save wiring in calculate_timeline()"
      contains: "\"slug\": slugify(args.name)"
  key_links:
    - from: "build_chart_json() meta dict"
      to: "chart.json on disk"
      via: "slugify(args.name) produces slug matching profile directory name"
      pattern: "\"slug\": slugify\\(args\\.name\\)"
    - from: "calculate_timeline() args.save check"
      to: "save_snapshot() helper"
      via: "same pattern as calculate_transits/progressions/solar_arcs"
      pattern: "save_snapshot.*timeline"
---

<objective>
Close two audit gaps from v1.1-MILESTONE-AUDIT.md: (1) add missing meta.slug field to chart.json output, and (2) wire --save flag into calculate_timeline() so timeline snapshots can be persisted.

Purpose: Makes SKILL.md routing table accurate — meta.slug reference (line 151) and "any predictive command" --save claim (line 168) both depend on these backend fixes.
Output: Updated backend/astrology_calc.py with both fixes applied.
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-tech-debt-cleanup/13-RESEARCH.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add meta.slug field and wire --save into timeline mode</name>
  <files>backend/astrology_calc.py</files>
  <action>
Two changes to backend/astrology_calc.py:

**Change 1 — Add meta.slug to build_chart_json():**

In the `build_chart_json()` function, find the meta dict (line ~1447-1461). Add `"slug": slugify(args.name)` as the second field, immediately after `"name": args.name`. The `slugify` function is already imported at module level. No signature change needed — `args.name` is already available inside the function.

Before:
```python
meta = {
    "name": args.name,
    "birth_date": args.date.strftime("%Y-%m-%d"),
```

After:
```python
meta = {
    "name": args.name,
    "slug": slugify(args.name),
    "birth_date": args.date.strftime("%Y-%m-%d"),
```

**Change 2 — Wire --save into calculate_timeline():**

In `calculate_timeline()`, find the block at lines ~688-689 where `print(json.dumps(timeline_dict, indent=2))` is followed immediately by `return 0`. Insert the save block between them, replicating the exact pattern from `calculate_transits()` (lines 494-500):

Before:
```python
        print(json.dumps(timeline_dict, indent=2))
        return 0
```

After:
```python
        print(json.dumps(timeline_dict, indent=2))

        if args.save:
            date_str = timeline_dict['meta'].get('start_date', 'unknown')
            try:
                out_path = save_snapshot(CHARTS_DIR / args.timeline, 'timeline', date_str, timeline_dict)
                print(f"Snapshot saved: {out_path}", file=sys.stderr)
            except Exception as e:
                print(f"Warning: Could not save snapshot: {e}", file=sys.stderr)

        return 0
```

Key details:
- Use `start_date` (not `end_date`) as filename anchor — convention matches how other modes use their primary date field
- Use `'timeline'` as the mode string — unique, no collision with `'transit'`
- Use `args.timeline` (the profile slug) as the first arg to save_snapshot — matches `args.transits` pattern in calculate_transits()
- The save block goes INSIDE the existing try block, after print() and before return 0
  </action>
  <verify>
Run these verification commands:

1. Syntax check:
```bash
source /c/NEW/backend/venv/Scripts/activate && python -c "import py_compile; py_compile.compile('/c/NEW/backend/astrology_calc.py', doraise=True)"
```

2. Verify meta.slug is present in build_chart_json:
```bash
grep -n '"slug": slugify(args.name)' /c/NEW/backend/astrology_calc.py
```
Expected: One match in the build_chart_json meta dict.

3. Verify --save block exists in calculate_timeline:
```bash
grep -A 5 "save_snapshot.*timeline" /c/NEW/backend/astrology_calc.py
```
Expected: Shows the save_snapshot call with 'timeline' mode string.

4. Verify SKILL.md accuracy (read-only check):
```bash
grep -n "meta.slug" ~/.claude/skills/natal-chart/SKILL.md
grep -n "any predictive command" ~/.claude/skills/natal-chart/SKILL.md
```
Expected: Line 151 references meta.slug (now valid), line 168 references "any predictive command" (now accurate since timeline supports --save).
  </verify>
  <done>
- build_chart_json() meta dict contains "slug": slugify(args.name) as the second field after "name"
- calculate_timeline() checks args.save after printing JSON and before returning 0
- save_snapshot() is called with mode='timeline', date_str from meta.start_date, and profile dir from args.timeline
- Python syntax check passes with no errors
- SKILL.md lines 151 and 168 are verified accurate without requiring text changes
  </done>
</task>

</tasks>

<verification>
1. `python -c "import py_compile; py_compile.compile('backend/astrology_calc.py', doraise=True)"` — no syntax errors
2. `grep '"slug": slugify' backend/astrology_calc.py` — returns exactly one match in build_chart_json
3. `grep "save_snapshot.*timeline" backend/astrology_calc.py` — returns exactly one match in calculate_timeline
4. `grep "meta.slug" ~/.claude/skills/natal-chart/SKILL.md` — line 151 reference confirmed valid
5. `grep "any predictive command" ~/.claude/skills/natal-chart/SKILL.md` — line 168 claim confirmed accurate
</verification>

<success_criteria>
- chart.json output from any new profile creation includes meta.slug matching the profile directory name
- --timeline SLUG --save produces a timeline-{start_date}.json snapshot file in the profile directory
- SKILL.md routing table is factually accurate for both meta.slug and --save scope (no text edits needed)
- No regressions: existing --transits --save, --progressions --save, and --solar-arcs --save continue to work
</success_criteria>

<output>
After completion, create `.planning/phases/13-tech-debt-cleanup/13-01-SUMMARY.md`
</output>
