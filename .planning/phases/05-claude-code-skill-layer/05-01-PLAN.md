---
phase: 05-claude-code-skill-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - "~/.claude/skills/natal-chart/SKILL.md"
autonomous: true
must_haves:
  truths:
    - "Skill definition file exists at ~/.claude/skills/natal-chart/SKILL.md with valid frontmatter"
    - "Skill routes to create mode when birth details (name, date, time, location) are provided in arguments"
    - "Skill routes to list/load mode when no arguments or 'list' is provided"
    - "Skill routes to name search mode when only a name is provided without birth details"
    - "Skill invokes Python backend via direct interpreter path (./venv/Scripts/python) from C:/NEW/backend/"
    - "User can select a profile from list output and skill loads that profile's chart.json"
    - "Skill loads chart.json into context using the Read tool after creation or profile selection"
    - "Skill handles errors from backend gracefully (validation errors, GeoNames failures, overwrite conflicts)"
  artifacts:
    - path: "~/.claude/skills/natal-chart/SKILL.md"
      provides: "Claude Code skill definition with three-mode routing logic"
      contains: "name: natal-chart"
  key_links:
    - from: "~/.claude/skills/natal-chart/SKILL.md"
      to: "C:/NEW/backend/astrology_calc.py"
      via: "Bash tool invocation with direct interpreter path"
      pattern: "venv/Scripts/python astrology_calc\\.py"
    - from: "~/.claude/skills/natal-chart/SKILL.md"
      to: "~/.natal-charts/{slug}/chart.json"
      via: "Read tool invocation to load profile data into context"
      pattern: "Read.*chart\\.json"
---

<objective>
Create the Claude Code skill definition file that serves as the user-facing interface to the natal chart generation system. The skill acts as an intelligent router between three modes: chart creation (birth details provided), profile listing (no arguments), and profile loading (interactive selection).

Purpose: This is the glue layer that makes the Python backend accessible as a natural Claude Code slash command, enabling users to generate and manage natal charts through conversational interaction.

Output: SKILL.md file installed at ~/.claude/skills/natal-chart/SKILL.md
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/04-data-output-storage/04-02-SUMMARY.md
@.planning/phases/05-claude-code-skill-layer/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skill definition file with three-mode routing logic</name>
  <files>~/.claude/skills/natal-chart/SKILL.md</files>
  <action>
Create directory ~/.claude/skills/natal-chart/ and write SKILL.md with the following structure:

**Frontmatter (YAML):**
```yaml
---
name: natal-chart
description: >
  Generate natal astrological charts from birth data (name, date, time, location)
  or list/load existing chart profiles. Use when user mentions birth chart,
  natal chart, astrology, horoscope, or wants to see their astrological chart.
allowed-tools:
  - Bash
  - Read
  - AskUserQuestion
---
```

Note: Use `allowed-tools` with Bash (for Python invocation), Read (for loading chart.json into context), and AskUserQuestion (for interactive profile selection).

**Mode Determination Section:**
Instruct Claude to inspect $ARGUMENTS and determine mode:
- **Create mode**: Arguments contain birth details (name AND date/time/location). Indicators: contains a date pattern (YYYY-MM-DD), contains time pattern (HH:MM), contains location words (city/nation or lat/lng/tz).
- **List/Load mode**: Arguments are empty, contain only "list", or contain just a person's name without date/time.
- **Name search mode**: Arguments contain only a name (no date/time/location) — search existing profiles first, offer to create if not found.

**Create Mode Section:**
Instructions for chart creation:
1. Parse birth details from $ARGUMENTS. Expected format: `"Person Name" --date YYYY-MM-DD --time HH:MM --city "City" --nation "CC"` OR `"Person Name" --date YYYY-MM-DD --time HH:MM --lat NN.NN --lng NN.NN --tz "Timezone"`
2. Invoke Python backend via Bash:
   ```bash
   cd C:/NEW/backend
   ./venv/Scripts/python astrology_calc.py "PERSON_NAME" --date DATE --time TIME --city "CITY" --nation "NATION"
   ```
3. Check exit code: 0 = success, 1 = error (overwrite conflict or runtime error), 2 = argument validation error
4. On success: Use Read tool to load ~/.natal-charts/{slugified-name}/chart.json into context. Display summary of chart (Sun sign, Moon sign, Rising sign from the JSON).
5. On overwrite conflict (exit code 1 with "already exists" in output): Inform user the profile exists, show existing birth data from output, ask if they want to overwrite using --force flag.
6. On validation error: Display the error message from Python and prompt user to correct input.

**List/Load Mode Section:**
Instructions for profile listing and selection:
1. List existing profiles via Bash:
   ```bash
   cd C:/NEW/backend
   ./venv/Scripts/python astrology_calc.py --list
   ```
2. Parse output to extract profile names and birth details.
3. If no profiles found: Inform user no charts exist yet, offer to create their first chart.
4. If profiles found: Use AskUserQuestion to present selection menu with options:
   - Each profile as "Name (Born: date at time, Location)"
   - Final option: "Create new chart instead"
5. After selection:
   - If "Create new chart" selected: Ask user for birth details (name, date, time, location), then invoke create mode.
   - If profile selected: Use Read tool to load ~/.natal-charts/{slug}/chart.json into context. Display summary (Sun, Moon, Rising from loaded JSON).

**Name Search Mode Section:**
When only a name is provided (no date/time/location):
1. List profiles and search for matching name.
2. If found: Load that profile (same as list/load selection).
3. If not found: Inform user no profile exists for that name, ask if they want to create one (gather birth details).

**Error Handling Section:**
- **Backend not found:** If ./venv/Scripts/python fails, suggest checking that C:/NEW/backend/venv exists and dependencies are installed (`pip install -r requirements.txt`).
- **GeoNames failure:** If backend reports GeoNames error, suggest using coordinate mode instead (--lat/--lng/--tz).
- **Invalid arguments:** Show Python's error message and provide correct format example.

**Context Loading Section:**
After loading chart.json (either from creation or profile selection):
- Read the JSON file content using the Read tool
- Present a brief summary: "Chart loaded for {name} — Sun in {sign}, Moon in {sign}, {sign} Rising"
- Mention that the full chart data is now in context for interpretation questions

Keep the entire SKILL.md under 200 lines. Focus on routing logic and invocation patterns. Do NOT include astrological interpretation instructions (that is Phase 6). Do NOT duplicate Python validation logic.
  </action>
  <verify>
Verify the skill file exists and has correct structure:

```bash
# File exists
[ -f "$HOME/.claude/skills/natal-chart/SKILL.md" ] && echo "SKILL.md exists" || echo "MISSING"

# Has frontmatter with required fields
head -10 "$HOME/.claude/skills/natal-chart/SKILL.md"

# Contains key routing sections
grep -c "Create" "$HOME/.claude/skills/natal-chart/SKILL.md"
grep -c "List" "$HOME/.claude/skills/natal-chart/SKILL.md"
grep -c "venv/Scripts/python" "$HOME/.claude/skills/natal-chart/SKILL.md"
grep -c "AskUserQuestion" "$HOME/.claude/skills/natal-chart/SKILL.md"
grep -c "chart.json" "$HOME/.claude/skills/natal-chart/SKILL.md"

# Under 200 lines
wc -l "$HOME/.claude/skills/natal-chart/SKILL.md"
```

All checks must pass.
  </verify>
  <done>
SKILL.md exists at ~/.claude/skills/natal-chart/SKILL.md with:
- Valid YAML frontmatter (name, description, allowed-tools)
- Three-mode routing logic (create, list/load, name search)
- Correct Python backend invocation commands using direct interpreter path
- AskUserQuestion integration for profile selection
- Error handling for common failure modes
- Context loading instructions using Read tool
- Under 200 lines total
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Python backend invocations match skill instructions</name>
  <files>~/.claude/skills/natal-chart/SKILL.md</files>
  <action>
Verify that the exact bash commands documented in the skill actually work by running them against the Python backend. This ensures the skill's instructions will produce correct results when Claude follows them.

**Test 1 — Create mode (city/nation):**
```bash
cd C:/NEW/backend
./venv/Scripts/python astrology_calc.py "Skill Test" --date 1990-06-15 --time 14:30 --city "London" --nation "GB"
echo "Exit code: $?"
```
Expected: Exit code 0, profile created at ~/.natal-charts/skill-test/

**Test 2 — Create mode (coordinates):**
```bash
cd C:/NEW/backend
./venv/Scripts/python astrology_calc.py "Coord Test" --date 1985-03-20 --time 08:00 --lat 40.7128 --lng -74.0060 --tz "America/New_York"
echo "Exit code: $?"
```
Expected: Exit code 0, profile created at ~/.natal-charts/coord-test/

**Test 3 — Overwrite protection:**
```bash
cd C:/NEW/backend
./venv/Scripts/python astrology_calc.py "Skill Test" --date 1990-06-15 --time 14:30 --city "London" --nation "GB"
echo "Exit code: $?"
```
Expected: Exit code 1, output contains "already exists" and existing birth details.

**Test 4 — List profiles:**
```bash
cd C:/NEW/backend
./venv/Scripts/python astrology_calc.py --list
echo "Exit code: $?"
```
Expected: Exit code 0, output lists "Skill Test" and "Coord Test" profiles with birth details.

**Test 5 — chart.json is readable:**
```bash
[ -f "$HOME/.natal-charts/skill-test/chart.json" ] && echo "chart.json exists" || echo "MISSING"
# Verify JSON has expected structure
python -c "import json; d=json.load(open('$HOME/.natal-charts/skill-test/chart.json')); print(f\"Sun: {d['planets'][0]['sign']}, Moon: {d['planets'][1]['sign']}\")"
```
Expected: chart.json exists and contains valid planet data.

**Test 6 — Validation error handling:**
```bash
cd C:/NEW/backend
./venv/Scripts/python astrology_calc.py "Bad Date" --date 2024-13-45 --time 14:30 --city "London" --nation "GB" 2>&1
echo "Exit code: $?"
```
Expected: Exit code 2, error message about invalid date.

**Test 7 — SKILL.md contains Read tool instructions for chart.json loading:**
```bash
# Verify SKILL.md instructs Claude to use Read tool for chart.json
grep -c "Read" "$HOME/.claude/skills/natal-chart/SKILL.md"
grep -c "chart.json" "$HOME/.claude/skills/natal-chart/SKILL.md"
# Verify both Read and chart.json appear in a context-loading instruction
grep -i "read.*chart\.json\|chart\.json.*read\|Read tool.*chart\|load.*chart\.json" "$HOME/.claude/skills/natal-chart/SKILL.md"
```
Expected: SKILL.md contains explicit instructions to use the Read tool to load chart.json into Claude's context after chart creation and after profile selection.

**Cleanup test profiles:**
```bash
rm -rf "$HOME/.natal-charts/skill-test" "$HOME/.natal-charts/coord-test"
```

If any test fails, update the SKILL.md to match actual backend behavior (correct command syntax, adjust error messages, fix path references). The skill must accurately reflect how the backend actually works.
  </action>
  <verify>
Run these verification commands after all tests complete:

```bash
# Confirm test profiles were cleaned up
[ ! -d "$HOME/.natal-charts/skill-test" ] && echo "CLEAN: skill-test removed" || echo "FAIL: skill-test still exists"
[ ! -d "$HOME/.natal-charts/coord-test" ] && echo "CLEAN: coord-test removed" || echo "FAIL: coord-test still exists"

# Re-verify SKILL.md still passes Task 1 structural checks after any corrections
[ -f "$HOME/.claude/skills/natal-chart/SKILL.md" ] && echo "PASS: SKILL.md exists" || echo "FAIL: SKILL.md missing"
grep -q "name: natal-chart" "$HOME/.claude/skills/natal-chart/SKILL.md" && echo "PASS: frontmatter intact" || echo "FAIL: frontmatter broken"
grep -q "venv/Scripts/python" "$HOME/.claude/skills/natal-chart/SKILL.md" && echo "PASS: backend invocation present" || echo "FAIL: backend invocation missing"
grep -qi "Read.*chart\.json\|chart\.json.*Read" "$HOME/.claude/skills/natal-chart/SKILL.md" && echo "PASS: Read tool chart.json loading present" || echo "FAIL: Read tool chart.json loading missing"
LINES=$(wc -l < "$HOME/.claude/skills/natal-chart/SKILL.md")
[ "$LINES" -lt 200 ] && echo "PASS: $LINES lines (under 200)" || echo "FAIL: $LINES lines (over 200)"
```

All lines must show PASS or CLEAN. No FAIL lines allowed.
  </verify>
  <done>
All Python backend invocations documented in the skill produce expected results:
- Create mode works with both city/nation and coordinate modes
- Overwrite protection fires correctly with exit code 1
- List mode shows all profiles with birth details
- chart.json files are readable and contain valid chart data
- Validation errors return exit code 2 with helpful messages
- SKILL.md contains explicit Read tool instructions for chart.json loading
- SKILL.md instructions match actual backend behavior exactly
  </done>
</task>

</tasks>

<verification>
Phase 5 verification:

1. **Skill file exists:** ~/.claude/skills/natal-chart/SKILL.md present with valid YAML frontmatter
2. **Create mode works:** Backend invocation with birth details creates chart and returns exit code 0
3. **List mode works:** Backend invocation with --list returns profile listing and exit code 0
4. **Load mode path:** chart.json files are readable at ~/.natal-charts/{slug}/chart.json
5. **Error handling:** Overwrite protection, validation errors, and GeoNames failures produce clear output
6. **Routing logic:** Skill has distinct sections for create, list/load, and name search modes
7. **Tool permissions:** allowed-tools includes Bash, Read, and AskUserQuestion
8. **Size constraint:** SKILL.md is under 200 lines (context window management)
</verification>

<success_criteria>
- SKILL.md installed at ~/.claude/skills/natal-chart/SKILL.md
- Skill has three-mode routing: create (birth details), list/load (no args), name search (name only)
- Python backend invocations in skill match actual CLI interface
- All backend invocation tests pass (create, list, overwrite, validation)
- Skill references correct paths: C:/NEW/backend/ for invocation, ~/.natal-charts/ for profiles
- Skill uses allowed-tools: Bash, Read, AskUserQuestion
- SKILL.md under 200 lines
</success_criteria>

<output>
After completion, create `.planning/phases/05-claude-code-skill-layer/05-01-SUMMARY.md`
</output>
