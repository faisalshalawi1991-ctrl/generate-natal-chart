---
phase: 02-core-calculation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/astrology_calc.py]
autonomous: true

must_haves:
  truths:
    - "Script accepts --city/--nation for GeoNames location lookup (online mode)"
    - "Script accepts --lat/--lng/--tz for offline coordinate mode"
    - "Script rejects invalid calendar dates (Feb 30, month 13, etc.)"
    - "Script rejects dates outside 1900-current year range"
    - "Script requires birth time (errors without --time)"
    - "Script displays resolved city, country, coordinates, and timezone after GeoNames lookup"
    - "Script prints clear error message when GeoNames lookup fails"
    - "Script prints all 10 planetary positions with sign, degree, house, and retrograde status"
    - "Script prints all 12 house cusps with sign and degree using Placidus system"
    - "Script prints all 4 angles (ASC, MC, DSC, IC) with sign and degree"
    - "Script prints major aspects between planets with orb and applying/separating status"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "Complete natal chart CLI with dual-mode location and full calculation output"
      contains: "NatalAspects"
  key_links:
    - from: "backend/astrology_calc.py"
      to: "kerykeion.AstrologicalSubjectFactory"
      via: "from_birth_data() with online=True/False"
      pattern: "online=True|online=False"
    - from: "backend/astrology_calc.py"
      to: "kerykeion.NatalAspects"
      via: "NatalAspects(subject) constructor"
      pattern: "NatalAspects\\(subject\\)"
    - from: "backend/astrology_calc.py"
      to: "kerykeion.KerykeionException"
      via: "except KerykeionException for GeoNames errors"
      pattern: "except KerykeionException"
---

<objective>
Implement dual-mode location handling (GeoNames online + offline coordinates), enhanced input validation, and full natal chart calculation extraction (planets, houses, angles, aspects, retrograde) in the existing CLI script.

Purpose: This is the core calculation engine — transforms the Phase 1 scaffold into a fully functional natal chart calculator that validates all input and outputs all essential astrological data.
Output: Updated `backend/astrology_calc.py` with complete input validation and calculation output.
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-calculation-engine/02-RESEARCH.md
@.planning/phases/01-foundation-setup/01-01-SUMMARY.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dual-mode location handling and enhanced input validation</name>
  <files>backend/astrology_calc.py</files>
  <action>
Refactor `backend/astrology_calc.py` to support both GeoNames online mode and offline coordinate mode, with enhanced validation. Specific changes:

**1. Add imports at top of file:**
- `from kerykeion import AstrologicalSubjectFactory, NatalAspects, KerykeionException`
- `import os`

**2. Enhance `valid_date()` function:**
- After strptime validation, add year range check: reject dates where year < 1900 or year > current year
- Error message: `f"Year must be between 1900 and {datetime.now().year}"`

**3. Refactor argparse arguments for dual-mode location:**
- Make `--lat`, `--lng`, `--tz` OPTIONAL (currently required) — these are for offline mode
- Add new optional arguments: `--city` (str) and `--nation` (str) for GeoNames online mode
- Update epilog with both usage examples (see research Pattern 1)

**4. Add location mode validation after parse_args():**
```python
has_geonames = args.city and args.nation
has_coords = args.lat is not None and args.lng is not None and args.tz
if not has_geonames and not has_coords:
    parser.error("Must provide either (--city and --nation) or (--lat, --lng, --tz)")
if has_geonames and has_coords:
    parser.error("Cannot mix location modes: use either (--city/--nation) or (--lat/--lng/--tz)")
```

**5. Implement dual-mode AstrologicalSubject creation:**
- **GeoNames mode (has_geonames=True):** Call `AstrologicalSubjectFactory.from_birth_data()` with `city=args.city, nation=args.nation, online=True, houses_system_identifier="P"`. Pass `geonames_username=os.getenv('KERYKEION_GEONAMES_USERNAME')` if env var is set (pass None otherwise, Kerykeion uses default).
- After successful creation, print resolved location for user verification:
  ```
  Location resolved: {subject.city}, {subject.nation}
  Coordinates: {subject.lat:.4f}, {subject.lng:.4f}
  Timezone: {subject.tz_str}
  ```
- Wrap GeoNames mode in `try/except KerykeionException as e:` — on failure, print to stderr: `Error: Unable to resolve location '{args.city}, {args.nation}'`, print `Details: {e}`, print tip about checking spelling and nation code. Return 1.
- **Offline mode (has_coords=True):** Keep existing `from_birth_data()` call with `online=False`, add `houses_system_identifier="P"`.

**6. Add Placidus verification after subject creation:**
```python
if subject.houses_system_identifier != "P":
    print(f"Warning: Expected Placidus (P), got {subject.houses_system_identifier}", file=sys.stderr)
```

**7. Verify --time remains required (INPT-02):**
- `--time` should already be a required argument from Phase 1. Do NOT change its `required=True` status.
- Confirm by inspection that `--time` is still defined as `required=True` in the argparse configuration. If it is not required, fix it to be required.

Do NOT add calculation output yet — that is Task 2. After subject creation and Placidus verification, keep the existing sun sign print as a temporary confirmation, or replace it with a simple "Chart calculated successfully for {name}" message.
  </action>
  <verify>
Run these commands from project root (activate venv first):

1. **Offline mode still works (regression):**
   ```
   python backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin"
   ```
   Expected: Successful output with chart confirmation, exit code 0.

2. **No location arguments produces error:**
   ```
   python backend/astrology_calc.py "Test" --date 1990-01-01 --time 12:00
   ```
   Expected: Error message about providing location arguments, exit code 2.

3. **Invalid date (Feb 30) rejected:**
   ```
   python backend/astrology_calc.py "Test" --date 1990-02-30 --time 12:00 --lat 40.7 --lng -74.0 --tz "America/New_York"
   ```
   Expected: ArgumentTypeError about invalid date, exit code 2.

4. **Future date rejected:**
   ```
   python backend/astrology_calc.py "Test" --date 2099-01-01 --time 12:00 --lat 40.7 --lng -74.0 --tz "America/New_York"
   ```
   Expected: ArgumentTypeError about year range, exit code 2.

5. **GeoNames online mode works (requires internet):**
   ```
   python backend/astrology_calc.py "Test" --date 1990-06-15 --time 14:30 --city "London" --nation "GB"
   ```
   Expected: "Location resolved: London, GB" (or similar) with coordinates and timezone displayed, exit code 0.

6. **GeoNames failure produces clear error:**
   ```
   python backend/astrology_calc.py "Test" --date 1990-06-15 --time 14:30 --city "INVALIDCITY12345" --nation "US"
   ```
   Expected: Clear error message about location resolution failure, exit code 1.

7. **Missing --time rejected (INPT-02):**
   ```
   python backend/astrology_calc.py "Test" --date 1990-01-01 --lat 40.7 --lng -74.0 --tz "America/New_York"
   ```
   Expected: Required argument error for missing --time, exit code 2.
  </verify>
  <done>
- `--city`/`--nation` arguments accepted for GeoNames online mode
- `--lat`/`--lng`/`--tz` arguments accepted for offline mode (no longer required)
- Script rejects mixing both location modes
- Script rejects missing location arguments
- valid_date rejects dates outside 1900-current year range
- GeoNames success displays resolved city, country, coordinates, timezone
- GeoNames failure displays clear error message with details and tip
- Offline mode regression test passes (Einstein data)
- Placidus house system verified after subject creation
- --time remains required; omitting it produces exit code 2 (INPT-02)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract and display full natal chart calculations</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add complete natal chart calculation extraction and output after the AstrologicalSubject creation from Task 1. All output goes to stdout after the location confirmation.

**1. Extract and print all 10 planetary positions (CALC-01, CALC-11):**
```python
planets = [
    ('Sun', subject.sun), ('Moon', subject.moon),
    ('Mercury', subject.mercury), ('Venus', subject.venus),
    ('Mars', subject.mars), ('Jupiter', subject.jupiter),
    ('Saturn', subject.saturn), ('Uranus', subject.uranus),
    ('Neptune', subject.neptune), ('Pluto', subject.pluto),
]
```
For each planet, print: name, sign, position (degrees within sign to 2 decimal places), house, and retrograde status. Format retrograde as " (R)" suffix when `planet.retrograde` is True. Use `getattr(planet, 'retrograde', False)` for safe access in case any body lacks the attribute.

Print header: `=== PLANETARY POSITIONS ===`

**2. Extract and print all 12 house cusps (CALC-02):**
```python
houses = [
    subject.first_house, subject.second_house, subject.third_house,
    subject.fourth_house, subject.fifth_house, subject.sixth_house,
    subject.seventh_house, subject.eighth_house, subject.ninth_house,
    subject.tenth_house, subject.eleventh_house, subject.twelfth_house,
]
```
For each house cusp, print: house number (1-12), sign, position (degrees within sign to 2 decimal places).

Print header: `=== HOUSE CUSPS (Placidus) ===`

**3. Extract and print all 4 angles (CALC-04):**
Print each angle on its own line: Ascendant (ASC), Midheaven (MC), Descendant (DSC), Imum Coeli (IC). Each shows sign and position (degrees to 2 decimal places).
- ASC: `subject.ascendant`
- MC: `subject.medium_coeli`
- DSC: `subject.descendant`
- IC: `subject.imum_coeli`

Print header: `=== ANGLES ===`

**4. Calculate and print major aspects (CALC-03):**
```python
from kerykeion import NatalAspects  # Already imported in Task 1
natal_aspects = NatalAspects(subject)
major_types = ['conjunction', 'opposition', 'trine', 'square', 'sextile']
filtered = [asp for asp in natal_aspects.all_aspects if asp.aspect in major_types]
```
For each aspect, print: planet 1 name, aspect type, planet 2 name, orb (degrees to 2 decimal places), and applying/separating status from `asp.aspect_movement`.

Print header: `=== MAJOR ASPECTS ===`
Print count: `Found {len(filtered)} major aspects:`

**5. Remove the old single-line sun sign output** — replace with the structured output above.
  </action>
  <verify>
Run these commands:

1. **Full chart output with offline mode (Einstein):**
   ```
   python backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin"
   ```
   Expected output contains ALL of:
   - `=== PLANETARY POSITIONS ===` section with 10 planets (Sun through Pluto)
   - Each planet shows sign, degree, house, and retrograde status
   - `=== HOUSE CUSPS (Placidus) ===` section with 12 houses (House 1 through House 12)
   - `=== ANGLES ===` section with ASC, MC, DSC, IC
   - `=== MAJOR ASPECTS ===` section with aspect count and list
   - Sun should be in Pisces (Pis)
   - Exit code 0

2. **Full chart output with online mode:**
   ```
   python backend/astrology_calc.py "Test Person" --date 1990-06-15 --time 14:30 --city "New York" --nation "US"
   ```
   Expected: Location resolved line followed by all 4 calculation sections, exit code 0.

3. **Verify retrograde detection:**
   Check output for any planet marked with (R) — outer planets (Saturn, Uranus, Neptune, Pluto) are commonly retrograde.

4. **Verify aspect filtering:**
   Output should only contain conjunction, opposition, trine, square, sextile — no minor aspects like quintile or semi-square.

5. **Count verification:**
   - Exactly 10 planets listed
   - Exactly 12 house cusps listed
   - Exactly 4 angles listed
   - Aspect count matches listed aspects
  </verify>
  <done>
- All 10 planets (Sun through Pluto) printed with sign, degree (within sign), house, retrograde status
- All 12 house cusps printed with sign and degree using Placidus system
- All 4 angles (ASC, MC, DSC, IC) printed with sign and degree
- Major aspects (conjunction, opposition, trine, square, sextile) printed with orb and applying/separating
- Minor aspects excluded from output
- Retrograde status correctly identified using safe attribute access
- Output is well-structured with section headers
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run full verification:

1. **Offline mode end-to-end (Einstein):**
   ```bash
   python backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin"
   ```
   Confirm: 10 planets + 12 houses + 4 angles + aspects all printed, Sun in Pisces, exit code 0.

2. **Online mode end-to-end:**
   ```bash
   python backend/astrology_calc.py "Test Person" --date 1990-06-15 --time 14:30 --city "London" --nation "GB"
   ```
   Confirm: Location resolved line + 10 planets + 12 houses + 4 angles + aspects, exit code 0.

3. **Validation gauntlet:**
   - `--date 1990-02-30` rejects (invalid calendar date)
   - `--date 2099-01-01` rejects (future date)
   - Missing `--time` rejects (birth time required)
   - Missing location args rejects (no city/nation or lat/lng/tz)
   - `--city "INVALID" --nation "XX"` produces clear GeoNames error

4. **Output completeness check:**
   - Grep output for "PLANETARY POSITIONS", "HOUSE CUSPS", "ANGLES", "MAJOR ASPECTS" headers
   - Count planet lines = 10, house lines = 12, angle lines = 4
</verification>

<success_criteria>
- All 10 phase success criteria from ROADMAP.md are met:
  1. 10 planetary positions with sign, degree, minute accuracy
  2. 12 house cusps using Placidus system
  3. Major aspects with correct orbs
  4. 4 angles with sign and degree
  5. Retrograde status identified
  6. Invalid calendar dates rejected
  7. Birth time required
  8. Location resolves via GeoNames
  9. Resolved city/country displayed
  10. GeoNames failures produce clear errors
- Offline mode (Phase 1) continues to work (regression)
- Script exit codes: 0 success, 1 runtime error, 2 argument error
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-calculation-engine/02-01-SUMMARY.md`
</output>
