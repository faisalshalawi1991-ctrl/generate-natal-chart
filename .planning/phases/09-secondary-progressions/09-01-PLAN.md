---
phase: 09-secondary-progressions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/astrology_calc.py
autonomous: true

must_haves:
  truths:
    - "User can calculate secondary progressions for a target date with --progressions SLUG --target-date YYYY-MM-DD"
    - "User can calculate secondary progressions for an age with --progressions SLUG --age N"
    - "User can see progressed-to-natal aspects with 1 degree orb in the JSON output"
    - "User can see monthly progressed Moon positions and sign changes for a target year"
    - "User can see element and modality distribution shifts between natal and progressed charts"
    - "Existing --transits, --timeline, --list, and natal chart creation modes continue working unchanged"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "Progressions constant, functions, CLI arguments, and main() routing"
      contains: "def calculate_progressions"
  key_links:
    - from: "main()"
      to: "calculate_progressions(args)"
      via: "args.progressions check before args.timeline check"
      pattern: "if args\\.progressions"
    - from: "calculate_progressions()"
      to: "load_natal_profile()"
      via: "function call to load natal subject and data"
      pattern: "load_natal_profile\\(args\\.progressions\\)"
    - from: "calculate_progressions()"
      to: "build_progressed_json()"
      via: "function call to assemble complete progressions JSON"
      pattern: "build_progressed_json\\("
    - from: "build_progressed_json()"
      to: "AspectsFactory.dual_chart_aspects()"
      via: "progressed-to-natal aspect calculation with PROG_DEFAULT_ORBS"
      pattern: "dual_chart_aspects.*PROG_DEFAULT_ORBS"
    - from: "build_progressed_json()"
      to: "build_monthly_moon()"
      via: "12-month progressed Moon tracking with sign change detection"
      pattern: "build_monthly_moon\\("
---

<objective>
Add secondary progressions calculation to the CLI via `--progressions SLUG` with `--target-date YYYY-MM-DD` or `--age N` options. Uses Swiss Ephemeris JD arithmetic for the day-for-a-year formula, Kerykeion `from_birth_data()` for progressed subject creation at natal location, and `AspectsFactory.dual_chart_aspects()` with 1-degree orbs for progressed-to-natal aspects. Includes monthly progressed Moon tracking and element/modality distribution shift analysis.

Purpose: Enables users to explore their secondary progressions — a core predictive technique in Western astrology — showing how planetary positions have symbolically evolved since birth, which progressed planets are aspecting natal planets, where the progressed Moon is transiting by sign each month, and how the overall element/modality balance has shifted.
Output: Updated `backend/astrology_calc.py` with progressions functionality (1 new constant, 4 new functions, 4 new CLI args, main() routing).
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-secondary-progressions/09-RESEARCH.md
@.planning/phases/07-current-transit-snapshots/07-01-SUMMARY.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progressions constant, functions, CLI arguments, and main() routing</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add 1 new import at the top of the file (after existing imports):
```python
import swisseph as swe
```

Add 1 new constant AFTER `MAJOR_PLANETS` and BEFORE `def valid_date(s)`:
```python
PROG_DEFAULT_ORBS = [
    ActiveAspect(name='conjunction', orb=1),
    ActiveAspect(name='opposition', orb=1),
    ActiveAspect(name='trine', orb=1),
    ActiveAspect(name='square', orb=1),
    ActiveAspect(name='sextile', orb=1),
]
```
This is the standard 1-degree orb for all progressed-to-natal aspects (Kepler College standard).

Add 4 new functions AFTER `calculate_timeline()` and BEFORE `position_to_sign_degree()`. Place them in this order:

**1. `compute_progressed_jd(birth_jd, target_jd)`**
- Implements the day-for-a-year formula: `return birth_jd + (target_jd - birth_jd) / 365.25`
- Takes two float Julian Day numbers
- Returns a float (the progressed Julian Day)
- Docstring should explain: one ephemeris day = one year of life; 365.25 is the Julian year divisor

**2. `build_monthly_moon(birth_jd, target_year, natal_lat, natal_lng, natal_tz_str)`**
- Calculates progressed Moon position for each month (1-12) of target_year
- For each month: compute target_jd = swe.julday(target_year, month, 1, 12.0), then progressed_jd via compute_progressed_jd, then swe.revjul to get calendar date, then AstrologicalSubjectFactory.from_birth_data() with natal lat/lng/tz
- Extract Moon sign via m_subj.moon.sign, degree via round(m_subj.moon.position % 30, 2)
- Track sign changes: if current sign != previous sign, add "sign_change": "PrevSign -> NewSign" to entry
- Returns list of 12 dicts: {"month": "YYYY-MM", "sign": "Xxx", "degree": float, "sign_change": "..." (optional)}
- See 09-RESEARCH.md Pattern 4 for exact implementation

**3. `build_progressed_json(progressed_subject, natal_subject, natal_data, slug, target_date_str, target_jd, birth_jd, prog_year)`**
- Assembles the complete progressions JSON dict with these top-level keys:

  **"meta":** natal_name (from natal_data["meta"]["name"]), natal_slug (slug), target_date (target_date_str), progressed_date (YYYY-MM-DD from swe.revjul of progressed_jd), progressed_time (HH:MM from same), age_at_target (int of (target_jd - birth_jd) / 365.25), chart_type="secondary_progressions", calculated_at (UTC ISO), orbs_used (dict from PROG_DEFAULT_ORBS), prog_year (the year used for monthly Moon)

  **"progressed_planets":** List of 10 planet dicts (Sun through Pluto). For each planet, access the attribute on progressed_subject (e.g., progressed_subject.sun). Extract: name, sign (.sign), degree (round(.position % 30, 2)), abs_position (round(.abs_pos, 2)), retrograde (getattr(planet, 'retrograde', False)).

  **"progressed_angles":** List with ASC and MC entries. For ASC: progressed_subject.ascendant (sign, degree = round(position % 30, 2), abs_position = round(abs_pos, 2)). For MC: progressed_subject.medium_coeli (same fields).

  **"progressed_aspects":** Use AspectsFactory.dual_chart_aspects(progressed_subject, natal_subject, active_points=MAJOR_PLANETS, active_aspects=PROG_DEFAULT_ORBS, second_subject_is_fixed=True). Loop through aspects_model.aspects, filter where asp.p1_name in MAJOR_PLANETS and asp.p2_name in MAJOR_PLANETS. Build list of dicts: progressed_planet (asp.p1_name), natal_planet (asp.p2_name), aspect (asp.aspect), orb (round(asp.orbit, 2)), applying (asp.aspect_movement == 'Applying'), movement (asp.aspect_movement).

  **"monthly_moon":** Call build_monthly_moon(birth_jd, prog_year, natal_lat, natal_lng, natal_tz_str). Extract natal_lat, natal_lng, natal_tz_str from natal_data["meta"]["location"].

  **"distribution_shift":** Compute element and modality distributions for BOTH natal_subject and progressed_subject using the same 11-placement approach (10 planets + ASC) with ELEMENT_MAP and MODALITY_MAP. For each element (Fire, Earth, Air, Water): {"natal": count, "progressed": count, "delta": prog-natal}. For each modality (Cardinal, Fixed, Mutable): same structure. Use a helper function or inline loop that iterates over [sun, moon, mercury, venus, mars, jupiter, saturn, uranus, neptune, pluto, ascendant] attributes.

- See 09-RESEARCH.md Pattern 7 for the complete target JSON output structure

**4. `calculate_progressions(args)`**
- Orchestrates the full Phase 9 pipeline:
  1. Call load_natal_profile(args.progressions) to get (natal_subject, natal_data)
  2. Extract natal location: natal_lat, natal_lng, natal_tz from natal_data["meta"]["location"]
  3. Extract birth date/time from natal_data["meta"]["birth_date"] and natal_data["meta"]["birth_time"]
  4. Compute birth_jd = swe.julday(year, month, day, hour + minute/60.0)
  5. Validate: if BOTH args.age and args.target_date are provided, print error "Cannot use both --age and --target-date" to stderr and return 1
  6. Determine target_jd:
     - If args.age is not None: target_jd = birth_jd + args.age * 365.25; compute target_date_str from swe.revjul(target_jd)
     - Elif args.target_date is not None: target_jd = swe.julday(year, month, day, 12.0); target_date_str = args.target_date.strftime("%Y-%m-%d")
     - Else (default): today UTC noon; target_date_str = today.strftime("%Y-%m-%d")
  7. Compute progressed JD: prog_jd = compute_progressed_jd(birth_jd, target_jd)
  8. Convert prog_jd to calendar date via swe.revjul; extract year, month, day, hour, minute
  9. Create progressed subject via AstrologicalSubjectFactory.from_birth_data() with progressed date and NATAL lat/lng/tz (CRITICAL: NOT lat=0.0 lng=0.0 — see 09-RESEARCH.md Pitfall 1)
  10. Determine prog_year: args.prog_year if provided, else year portion of target date (or birth_year + age if age-based)
  11. Call build_progressed_json() with all assembled data
  12. Print JSON to stdout with indent=2
  13. Return 0
- Wrap entire body in try/except: FileNotFoundError, Exception — print to stderr and return 1
- See 09-RESEARCH.md "Complete calculate_progressions() Orchestration" for reference

Add 4 new CLI arguments in main() parser section, AFTER the --end argument block and BEFORE `args = parser.parse_args()`:

```python
parser.add_argument(
    '--progressions',
    metavar='SLUG',
    help='Calculate secondary progressions for an existing chart profile (e.g., albert-einstein)'
)
parser.add_argument(
    '--target-date',
    type=valid_query_date,
    default=None,
    dest='target_date',
    help='Target date for progressions YYYY-MM-DD (default: today UTC)'
)
parser.add_argument(
    '--age',
    type=int,
    default=None,
    help='Target age in whole years for progressions (alternative to --target-date)'
)
parser.add_argument(
    '--prog-year',
    type=int,
    default=None,
    dest='prog_year',
    help='Year for monthly progressed Moon report (default: year of target date)'
)
```

Add progressions routing in main() AFTER the `--list` check and BEFORE the `--timeline` check:
```python
# Handle --progressions flag (MUST come before --timeline, --transits, and natal validation)
if args.progressions:
    return calculate_progressions(args)
```

IMPORTANT constraints:
- Do NOT modify any existing functions (load_natal_profile, build_transit_json, calculate_transits, calculate_timeline, etc.)
- Use NATAL lat/lng/tz for progressed subject creation (NOT lat=0.0, lng=0.0 like transit subjects)
- Use PROG_DEFAULT_ORBS (1-degree) for progressed aspects, NOT TRANSIT_DEFAULT_ORBS
- Use 365.25 (Julian year) as the divisor in the day-for-a-year formula
- Error if both --age and --target-date are provided (return 1 with stderr message)
- The --target-date argument reuses valid_query_date validator (1900-2100 range) — does NOT conflict with --query-date from Phase 7 (different dest= names)
  </action>
  <verify>
Run all modes to confirm no regressions and new functionality works:

```bash
# 1. Verify existing --list mode still works
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --list

# 2. Verify --progressions with default (today)
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --progressions albert-einstein

# 3. Verify --progressions with --target-date
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --progressions albert-einstein --target-date 2026-02-17

# 4. Verify --progressions with --age
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --progressions albert-einstein --age 30

# 5. Verify --progressions with --prog-year override
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --progressions albert-einstein --target-date 2026-02-17 --prog-year 2025

# 6. Verify error: both --age and --target-date
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --progressions albert-einstein --age 30 --target-date 2026-02-17

# 7. Verify error: non-existent profile
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --progressions nonexistent-person

# 8. Verify --transits still works (regression check)
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits albert-einstein

# 9. Verify --timeline still works (regression check)
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline albert-einstein --range week

# 10. Verify --help shows new arguments
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --help
```

All commands should exit with expected codes (0 for success, 1 for validation errors).
  </verify>
  <done>
- `--progressions SLUG` with default (today UTC) outputs complete progressions JSON with meta, progressed_planets, progressed_angles, progressed_aspects, monthly_moon, and distribution_shift sections
- `--progressions SLUG --target-date YYYY-MM-DD` calculates progressions for specified date
- `--progressions SLUG --age N` calculates progressions for N years after birth
- `--progressions SLUG --prog-year YYYY` overrides the year used for monthly Moon report
- Progressed aspects use 1-degree orb for all aspect types (PROG_DEFAULT_ORBS)
- Monthly Moon shows 12 entries with sign change detection
- Distribution shift shows natal vs progressed element and modality counts with delta
- Error if both --age and --target-date provided (exit 1)
- Error if profile not found (exit 1)
- Existing --transits, --timeline, --list, and natal creation modes are completely unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end progressions verification across all input modes</name>
  <files>backend/astrology_calc.py</files>
  <action>
Run comprehensive verification of the progressions feature. This task produces no code changes — it validates Task 1 output.

**Verification matrix:**

1. **Default target (today)** — Run `--progressions albert-einstein`. Verify:
   - JSON output has "meta.chart_type" = "secondary_progressions"
   - "meta.target_date" is today's date (2026-02-17 or current)
   - "meta.age_at_target" is a reasonable integer (~147 for Einstein)
   - "meta.orbs_used" shows all 5 aspects at orb 1
   - "progressed_planets" has exactly 10 entries (Sun through Pluto)
   - Each planet has name, sign, degree, abs_position, retrograde fields
   - "progressed_angles" has ASC and MC entries
   - "progressed_aspects" is a list with entries having progressed_planet, natal_planet, aspect, orb, applying, movement fields
   - All orb values in progressed_aspects are <= 1.0
   - "monthly_moon" has exactly 12 entries, each with month, sign, degree
   - "distribution_shift" has elements (4) and modalities (3) each with natal, progressed, delta

2. **Target date** — Run `--progressions albert-einstein --target-date 2026-02-17`. Verify:
   - "meta.target_date" is "2026-02-17"
   - "meta.progressed_date" is approximately "1879-08-08" (verified in research)
   - Output structure is identical to default mode

3. **Age input** — Run `--progressions albert-einstein --age 30`. Verify:
   - "meta.age_at_target" is 30
   - "meta.progressed_date" is approximately "1879-04-13" (30 days after March 14)
   - "progressed_planets" contains valid positions (all sign values are valid zodiac signs)

4. **Prog-year override** — Run `--progressions albert-einstein --target-date 2026-02-17 --prog-year 2025`. Verify:
   - "meta.prog_year" is 2025
   - "monthly_moon" entries have month values starting with "2025-"

5. **Error cases** — Verify each returns exit code 1 with error on stderr:
   - `--progressions albert-einstein --age 30 --target-date 2026-02-17` (both provided)
   - `--progressions nonexistent-slug` (missing profile)

6. **Regression check** — Run all pre-existing modes:
   - `--transits albert-einstein` → "chart_type" is "transit_snapshot" (not progressions)
   - `--timeline albert-einstein --range week` → "chart_type" is "transit_timeline"
   - `--list` → lists profiles normally

If any check fails, fix the issue in the implementation before marking done.
  </action>
  <verify>
All 6 verification categories pass. Specific checks:
```bash
# Quick validation: progressions produces valid JSON with correct structure
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --progressions albert-einstein --target-date 2026-02-17 2>&1 | python -c "import sys,json; d=json.load(sys.stdin); print(f'Type: {d[\"meta\"][\"chart_type\"]}, Planets: {len(d[\"progressed_planets\"])}, Aspects: {len(d[\"progressed_aspects\"])}, Moon entries: {len(d[\"monthly_moon\"])}, Age: {d[\"meta\"][\"age_at_target\"]}')"

# Regression: transits still work
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits albert-einstein 2>&1 | python -c "import sys,json; d=json.load(sys.stdin); print(f'Type: {d[\"meta\"][\"chart_type\"]}')"

# Regression: timeline still works
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline albert-einstein --range week 2>&1 | python -c "import sys,json; d=json.load(sys.stdin); print(f'Type: {d[\"meta\"][\"chart_type\"]}')"
```
  </verify>
  <done>
- Default (today), --target-date, --age, and --prog-year modes all produce valid progressions JSON
- All JSON sections present: meta, progressed_planets (10), progressed_angles (ASC/MC), progressed_aspects (all orbs <= 1.0), monthly_moon (12), distribution_shift
- Error cases return exit code 1 with descriptive stderr messages
- --transits, --timeline, --list modes are completely unaffected (regression-free)
- Progressed date approximately matches research verification values
  </done>
</task>

</tasks>

<verification>
1. `--progressions albert-einstein` exits 0, outputs JSON with meta.chart_type="secondary_progressions" and all 6 top-level sections
2. `--progressions albert-einstein --target-date 2026-02-17` exits 0, progressed_date is approximately 1879-08-08
3. `--progressions albert-einstein --age 30` exits 0, age_at_target=30, progressed_date is ~30 days after birth
4. `--progressions albert-einstein --prog-year 2025` exits 0, monthly_moon months start with "2025-"
5. `--progressions albert-einstein --age 30 --target-date 2026-02-17` exits 1 with error on stderr
6. `--progressions nonexistent-slug` exits 1 with error on stderr
7. `--transits albert-einstein` still produces transit_snapshot JSON (regression-free)
8. `--timeline albert-einstein --range week` still produces transit_timeline JSON (regression-free)
9. `--list` still works unchanged
10. `--help` shows --progressions, --target-date, --age, --prog-year arguments
</verification>

<success_criteria>
- Secondary progressions calculated via day-for-a-year formula using Swiss Ephemeris JD arithmetic
- Progressed subject created at natal location (not lat=0.0 lng=0.0)
- Progressed-to-natal aspects computed with 1-degree orb (PROG_DEFAULT_ORBS)
- Monthly progressed Moon tracking for 12 months with sign change detection
- Element and modality distribution shifts computed and displayed with deltas
- --target-date and --age inputs both work (mutually exclusive, error if both provided)
- --prog-year override works for monthly Moon year
- Complete JSON output with meta, progressed_planets, progressed_angles, progressed_aspects, monthly_moon, distribution_shift
- Zero regressions to existing --transits, --timeline, --list, and natal chart creation modes
</success_criteria>

<output>
After completion, create `.planning/phases/09-secondary-progressions/09-01-SUMMARY.md`
</output>
