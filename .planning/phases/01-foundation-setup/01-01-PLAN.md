---
phase: 01-foundation-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/astrology_calc.py
  - backend/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Python script accepts name, date, time, latitude, longitude, and timezone arguments via CLI"
    - "Kerykeion 5.7.2 is pinned in requirements.txt and installable"
    - "Script creates AstrologicalSubject from test birth data and prints sun sign/position"
    - "All file paths use pathlib.Path, no string concatenation"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "CLI entry point with argparse, Kerykeion integration, pathlib usage"
      min_lines: 60
      contains: "if __name__"
    - path: "backend/requirements.txt"
      provides: "Pinned Kerykeion dependency"
      contains: "kerykeion==5.7.2"
  key_links:
    - from: "backend/astrology_calc.py"
      to: "kerykeion"
      via: "AstrologicalSubjectFactory.from_birth_data(online=False)"
      pattern: "from_birth_data.*online=False"
    - from: "backend/astrology_calc.py"
      to: "argparse"
      via: "CLI argument parsing with custom type validators"
      pattern: "argparse\\.ArgumentParser"
    - from: "backend/astrology_calc.py"
      to: "pathlib"
      via: "Path import and usage for cross-platform paths"
      pattern: "from pathlib import Path"
---

<objective>
Create the Python backend foundation: project structure with pinned dependencies and a CLI script that accepts birth data arguments, validates input, creates a Kerykeion AstrologicalSubject in offline mode, and outputs basic chart confirmation.

Purpose: Establishes the executable backend that all subsequent phases build upon. Without a working CLI script and Kerykeion integration, no chart calculations, data output, or skill integration can proceed.
Output: backend/astrology_calc.py (CLI script), backend/requirements.txt (pinned deps)
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/NEW/.planning/PROJECT.md
@C:/NEW/.planning/ROADMAP.md
@C:/NEW/.planning/STATE.md
@C:/NEW/.planning/phases/01-foundation-setup/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure and pinned requirements</name>
  <files>backend/requirements.txt</files>
  <action>
Create the backend/ directory at the project root (C:/NEW/backend/).

Create backend/requirements.txt with exact pinned version:
```
kerykeion==5.7.2
```

Only pin the top-level dependency. Kerykeion's transitive dependencies (pyswisseph, pydantic, pytz) will be resolved automatically by pip. Do NOT add transitive dependencies manually.

Then create a Python virtual environment and install dependencies:
```bash
cd C:/NEW/backend
python -m venv venv
# Activate (the executor should detect platform)
# Windows: source venv/Scripts/activate
# Unix: source venv/bin/activate
pip install -r requirements.txt
```

Verify installation succeeds and kerykeion is importable:
```bash
python -c "import kerykeion; print(kerykeion.__version__)"
```

Do NOT commit the venv/ directory. If a .gitignore exists at project root, ensure venv/ is listed. If no .gitignore exists, create one at C:/NEW/.gitignore with at minimum:
```
backend/venv/
__pycache__/
*.pyc
```
  </action>
  <verify>
Run: `C:/NEW/backend/venv/Scripts/python -c "from kerykeion import AstrologicalSubjectFactory; print('OK')"` (Windows) or equivalent Unix path. Must print "OK" without errors.
Verify backend/requirements.txt exists and contains "kerykeion==5.7.2".
  </verify>
  <done>
backend/requirements.txt exists with kerykeion==5.7.2 pinned. Virtual environment created at backend/venv/ with Kerykeion installed and importable. .gitignore excludes venv/ and __pycache__/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI script with Kerykeion integration and input validation</name>
  <files>backend/astrology_calc.py</files>
  <action>
Create backend/astrology_calc.py following the patterns from 01-RESEARCH.md.

The script must implement:

1. **Shebang and docstring:** `#!/usr/bin/env python3` with module docstring explaining purpose.

2. **Imports:** argparse, sys, pathlib.Path, datetime, and kerykeion.AstrologicalSubjectFactory. Use `from pathlib import Path` (for cross-platform path handling per INFR-04).

3. **Custom argparse type validators:**
   - `valid_date(s)`: Validates YYYY-MM-DD format using datetime.strptime. Raises argparse.ArgumentTypeError on invalid input.
   - `valid_time(s)`: Validates HH:MM 24-hour format using datetime.strptime("%H:%M"). Raises argparse.ArgumentTypeError on invalid input.
   - `valid_latitude(s)`: Converts to float, validates -90 to 90 range.
   - `valid_longitude(s)`: Converts to float, validates -180 to 180 range.

4. **main() function** containing:
   - argparse.ArgumentParser with description "Generate astrological birth chart data"
   - Positional argument: `name` (person's name)
   - Required arguments: `--date` (type=valid_date), `--time` (type=valid_time), `--lat` (type=valid_latitude), `--lng` (type=valid_longitude), `--tz` (IANA timezone string, no validation beyond requiring it -- Kerykeion handles timezone validation)
   - Parse args, then create AstrologicalSubject:
     ```python
     subject = AstrologicalSubjectFactory.from_birth_data(
         name=args.name,
         year=args.date.year,
         month=args.date.month,
         day=args.date.day,
         hour=args.time.hour,
         minute=args.time.minute,
         lng=args.lng,
         lat=args.lat,
         tz_str=args.tz,
         online=False
     )
     ```
   - On success: print confirmation with name, sun sign, and sun position (e.g., "Chart created for John Doe -- Sun in Gemini at 24.52 degrees"). Access via subject.sun.sign and subject.sun.abs_pos.
   - On error: print error to stderr, return 1.
   - Return 0 on success.

5. **Entry point guard:** `if __name__ == "__main__": sys.exit(main())`

6. **What to avoid and why:**
   - No global variables -- all logic inside functions (main pattern from research)
   - No string path concatenation -- use pathlib.Path (INFR-04 requirement)
   - No online=True -- must use offline mode to avoid GeoNames dependency (research anti-pattern)
   - No bare except -- catch specific exceptions or at minimum use `except Exception as e`
   - Do NOT add location-to-coordinate lookup yet -- that is Phase 2 scope (INPT-03). This phase accepts raw lat/lng/tz directly.
  </action>
  <verify>
Run from the project root using the venv Python, with test birth data:
```bash
C:/NEW/backend/venv/Scripts/python C:/NEW/backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin"
```
Expected: Script prints success message with Einstein's sun sign (Pisces) and degree position. Exit code 0.

Test invalid date:
```bash
C:/NEW/backend/venv/Scripts/python C:/NEW/backend/astrology_calc.py "Test" --date 2024-13-45 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "America/New_York"
```
Expected: argparse error about invalid date, exit code 2.

Test missing required arg:
```bash
C:/NEW/backend/venv/Scripts/python C:/NEW/backend/astrology_calc.py "Test" --date 2024-01-01 --lat 40.7 --lng -74.0 --tz "America/New_York"
```
Expected: argparse error about missing --time, exit code 2.

Test invalid coordinate:
```bash
C:/NEW/backend/venv/Scripts/python C:/NEW/backend/astrology_calc.py "Test" --date 2024-01-01 --time 12:00 --lat 999 --lng -74.0 --tz "America/New_York"
```
Expected: argparse error about invalid latitude, exit code 2.
  </verify>
  <done>
backend/astrology_calc.py exists with: main() function using argparse with 6 arguments (name, --date, --time, --lat, --lng, --tz), custom type validators for date/time/lat/lng, AstrologicalSubjectFactory.from_birth_data() call with online=False, pathlib imported for future path operations, proper exit codes (0 success, 1 runtime error, 2 arg validation), and if __name__ == "__main__" guard. Test run with Einstein's birth data returns Pisces sun sign.
  </done>
</task>

</tasks>

<verification>
Phase 1 is complete when ALL of these pass:

1. `ls C:/NEW/backend/requirements.txt` -- file exists
2. `grep "kerykeion==5.7.2" C:/NEW/backend/requirements.txt` -- exact version pinned
3. `C:/NEW/backend/venv/Scripts/python -c "from kerykeion import AstrologicalSubjectFactory; print('importable')"` -- prints "importable"
4. `C:/NEW/backend/venv/Scripts/python C:/NEW/backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin"` -- outputs success with "Pisces", exits 0
5. `grep "from pathlib import Path" C:/NEW/backend/astrology_calc.py` -- pathlib imported
6. `grep "online=False" C:/NEW/backend/astrology_calc.py` -- offline mode enforced
7. `grep "if __name__" C:/NEW/backend/astrology_calc.py` -- entry point guard present
</verification>

<success_criteria>
- Python CLI script at backend/astrology_calc.py accepts name, --date, --time, --lat, --lng, --tz and creates a Kerykeion AstrologicalSubject
- requirements.txt pins kerykeion==5.7.2
- Virtual environment at backend/venv/ has Kerykeion installed
- Script validates input (date format, time format, coordinate ranges) before calculation
- Script uses pathlib for path handling, online=False for Kerykeion, main() pattern with sys.exit
- Test run with known birth data (Einstein: 1879-03-14, 11:30, Ulm) returns correct sun sign (Pisces)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-01-SUMMARY.md`
</output>
