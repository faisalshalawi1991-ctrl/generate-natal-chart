---
phase: 12-snapshot-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/astrology_calc.py
  - ~/.claude/skills/natal-chart/SKILL.md
autonomous: true

must_haves:
  truths:
    - "User can save a transit snapshot to disk with --save flag"
    - "User can save a progressions snapshot to disk with --save flag"
    - "User can save a solar arc snapshot to disk with --save flag"
    - "Snapshot files use date-based naming ({mode}-{YYYY-MM-DD}.json) in existing profile directory"
    - "JSON stdout output is unaffected by --save (confirmation goes to stderr only)"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "save_snapshot() helper function and --save flag"
      contains: "def save_snapshot"
    - path: "~/.natal-charts/{slug}/transit-{date}.json"
      provides: "Persisted transit snapshot"
    - path: "~/.natal-charts/{slug}/progressions-{date}.json"
      provides: "Persisted progressions snapshot"
    - path: "~/.natal-charts/{slug}/solar-arc-{date}.json"
      provides: "Persisted solar arc snapshot"
  key_links:
    - from: "calculate_transits()"
      to: "save_snapshot()"
      via: "args.save conditional after print(json.dumps(transit_dict))"
      pattern: "if args\\.save.*save_snapshot"
    - from: "calculate_progressions()"
      to: "save_snapshot()"
      via: "args.save conditional after print(json.dumps(prog_dict))"
      pattern: "if args\\.save.*save_snapshot"
    - from: "calculate_solar_arcs()"
      to: "save_snapshot()"
      via: "args.save conditional after print(json.dumps(sarc_dict))"
      pattern: "if args\\.save.*save_snapshot"
---

<objective>
Add optional snapshot persistence to all three predictive modes (transits, progressions, solar arcs) via a --save CLI flag, plus minimal SKILL.md routing update so Claude knows to pass --save when users request it.

Purpose: Satisfies INTG-05 (user can save transit/progression/solar arc snapshots for future reference) and INTG-06 (snapshot files stored with date-based naming in existing profile directories). This is the final phase of v1.1.

Output: save_snapshot() helper function, --save flag, call sites in 3 calculate functions, updated SKILL.md routing table.
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-snapshot-storage/12-RESEARCH.md
@backend/astrology_calc.py
@~/.claude/skills/natal-chart/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --save flag, save_snapshot() helper, and call sites in all three calculate functions plus SKILL.md routing</name>
  <files>backend/astrology_calc.py, ~/.claude/skills/natal-chart/SKILL.md</files>
  <action>
In backend/astrology_calc.py:

1. **Add save_snapshot() helper function** — Place it after the existing `load_natal_profile()` function (around line 421, before `calculate_transits()`). Implementation:

```python
def save_snapshot(profile_dir, mode, date_str, data):
    """
    Write predictive snapshot JSON to the profile directory.

    Args:
        profile_dir: Path — ~/.natal-charts/{slug}/
        mode:        str  — 'transit', 'progressions', or 'solar-arc'
        date_str:    str  — YYYY-MM-DD for filename (from meta field)
        data:        dict — already-assembled JSON dict from build_*_json()

    Returns:
        Path: The written file path (for confirmation message)
    """
    filename = f"{mode}-{date_str}.json"
    out_path = profile_dir / filename
    with open(out_path, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)
    return out_path
```

2. **Add --save argparse flag** — Place it directly after the `--force` argument definition (after line 1813). Follow the exact same pattern:

```python
parser.add_argument(
    '--save',
    action='store_true',
    help='Save snapshot to profile directory with date-based filename'
)
```

3. **Add save call site in calculate_transits()** — Between `print(json.dumps(transit_dict, indent=2))` (line 472) and `return 0` (line 473). Insert:

```python
        if args.save:
            date_str = transit_dict['meta'].get('query_date', 'unknown')
            try:
                out_path = save_snapshot(CHARTS_DIR / args.transits, 'transit', date_str, transit_dict)
                print(f"Snapshot saved: {out_path}", file=sys.stderr)
            except Exception as e:
                print(f"Warning: Could not save snapshot: {e}", file=sys.stderr)
```

Use `CHARTS_DIR / args.transits` for the profile directory. Print confirmation to stderr (NEVER stdout — would corrupt JSON output). Wrap in try/except so a save failure does not affect the already-printed JSON output.

4. **Add save call site in calculate_progressions()** — Between `print(json.dumps(prog_dict, indent=2))` (line 1006) and `return 0` (line 1007). Insert:

```python
        if args.save:
            date_str = prog_dict['meta'].get('target_date', 'unknown')
            try:
                out_path = save_snapshot(CHARTS_DIR / args.progressions, 'progressions', date_str, prog_dict)
                print(f"Snapshot saved: {out_path}", file=sys.stderr)
            except Exception as e:
                print(f"Warning: Could not save snapshot: {e}", file=sys.stderr)
```

Note: `meta['target_date']` is always a real date string by the time it reaches the dict — `build_progressed_json()` computes it from `swe.revjul(target_jd)` when the caller passes `None` (age-based mode). No extra None guard needed here.

5. **Add save call site in calculate_solar_arcs()** — Between `print(json.dumps(sarc_dict, indent=2))` (line 1287) and `return 0` (line 1288). Insert:

```python
        if args.save:
            date_str = sarc_dict['meta'].get('target_date', 'unknown')
            try:
                out_path = save_snapshot(CHARTS_DIR / args.solar_arcs, 'solar-arc', date_str, sarc_dict)
                print(f"Snapshot saved: {out_path}", file=sys.stderr)
            except Exception as e:
                print(f"Warning: Could not save snapshot: {e}", file=sys.stderr)
```

NOTE: Mode string is 'solar-arc' (hyphenated) to match natural filename convention.

6. **Update SKILL.md routing** — In the SKILL.md file at `~/.claude/skills/natal-chart/SKILL.md`, find the intent-to-flag routing table or predictive mode documentation. Add a note that `--save` can be appended to any predictive mode command to persist the snapshot:

Add to the predictive mode routing section (after the existing flag table):
```
- **Save snapshot**: If user says "save this", "keep this", or "store this snapshot" → append `--save` to the predictive command
```

Also add `--save` to any example commands that show predictive mode invocations, showing it as an optional flag.
  </action>
  <verify>
Run all three modes with --save and verify file creation:

```bash
# Transit with --save
source /c/NEW/backend/venv/Scripts/activate
python /c/NEW/backend/astrology_calc.py --transits albert-einstein --save 2>/dev/null | python -c "import json,sys; d=json.load(sys.stdin); print('Transit JSON valid:', d['meta']['chart_type'])"
ls ~/.natal-charts/albert-einstein/transit-*.json

# Progressions with --save
python /c/NEW/backend/astrology_calc.py --progressions albert-einstein --save 2>/dev/null | python -c "import json,sys; d=json.load(sys.stdin); print('Prog JSON valid:', d['meta']['chart_type'])"
ls ~/.natal-charts/albert-einstein/progressions-*.json

# Solar arcs with --save
python /c/NEW/backend/astrology_calc.py --solar-arcs albert-einstein --save 2>/dev/null | python -c "import json,sys; d=json.load(sys.stdin); print('SA JSON valid:', d['meta']['chart_type'])"
ls ~/.natal-charts/albert-einstein/solar-arc-*.json

# Without --save (no file created for a different date)
python /c/NEW/backend/astrology_calc.py --transits albert-einstein --query-date 1900-01-01 2>/dev/null | python -c "import json,sys; d=json.load(sys.stdin); print('No-save JSON valid:', d['meta']['chart_type'])"
ls ~/.natal-charts/albert-einstein/transit-1900-01-01.json 2>/dev/null && echo "BUG: file exists without --save" || echo "PASS: no file without --save"

# Verify stderr message appears with --save
python /c/NEW/backend/astrology_calc.py --transits albert-einstein --save 2>&1 1>/dev/null | grep -c "Snapshot saved"

# Regression: natal, --list, --timeline all still work
python /c/NEW/backend/astrology_calc.py --list
```
  </verify>
  <done>
  - save_snapshot() function exists in backend/astrology_calc.py
  - --save flag accepted by argparse
  - Transit --save creates transit-{date}.json in profile directory
  - Progressions --save creates progressions-{date}.json in profile directory
  - Solar arcs --save creates solar-arc-{date}.json in profile directory
  - JSON stdout remains valid (parseable) when --save is used
  - Confirmation message appears on stderr (not stdout)
  - Without --save, no snapshot files are created
  - SKILL.md documents --save flag routing for predictive modes
  - Existing modes (natal create, --list, --transits, --timeline, --progressions, --solar-arcs without --save) are unaffected
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end snapshot storage verification</name>
  <files>backend/astrology_calc.py</files>
  <action>
Verify all Phase 12 success criteria end-to-end:

1. **INTG-05 verification:** Run each of the three predictive modes with --save and confirm a snapshot file is created in the correct profile directory with the correct content:
   - Transit: `--transits albert-einstein --save` → `~/.natal-charts/albert-einstein/transit-{today}.json` exists and contains valid JSON with `chart_type: "transit_snapshot"`
   - Progressions: `--progressions albert-einstein --save` → `~/.natal-charts/albert-einstein/progressions-{today}.json` exists and contains `chart_type: "secondary_progressions"`
   - Solar arcs: `--solar-arcs albert-einstein --save` → `~/.natal-charts/albert-einstein/solar-arc-{today}.json` exists and contains `chart_type: "solar_arc_directions"`

2. **INTG-06 verification:** Confirm file naming follows `{mode}-{YYYY-MM-DD}.json` pattern:
   - Use `--query-date 2025-06-15` with transits → file named `transit-2025-06-15.json`
   - Use `--target-date 2025-06-15` with progressions → file named `progressions-2025-06-15.json`
   - Use `--target-date 2025-06-15` with solar arcs → file named `solar-arc-2025-06-15.json`

3. **Age-based progressions filename:** Run `--progressions albert-einstein --age 30 --save` and verify the filename contains the computed date (not "None" or "unknown")

4. **No corruption:** Pipe each --save command's stdout through `python -c "import json,sys;json.load(sys.stdin)"` to confirm stdout remains valid JSON (no stderr leakage)

5. **Regression check:** Run --list, --transits (without --save), --timeline, natal create (with --force), and confirm all modes still work correctly

6. **Overwrite behavior:** Run the same --save command twice and confirm it silently overwrites (no error, no prompt)
  </action>
  <verify>All verification commands from above exit 0 and produce expected output. No regression in any existing mode.</verify>
  <done>
  - All INTG-05 criteria satisfied: snapshots saveable for transits, progressions, and solar arcs
  - All INTG-06 criteria satisfied: date-based naming in existing profile directories
  - Age-based progressions produces valid filename (not None)
  - stdout JSON never corrupted by --save
  - Silent overwrite confirmed
  - All pre-existing modes unaffected
  </done>
</task>

</tasks>

<verification>
Phase 12 success criteria from ROADMAP.md:
1. User can save transit, progression, and solar arc snapshots with --save flag — verified by running all three modes with --save and confirming file creation
2. Snapshot files are stored with date-based naming in existing profile directories — verified by checking filenames match {mode}-{YYYY-MM-DD}.json pattern in ~/.natal-charts/{slug}/
</verification>

<success_criteria>
- save_snapshot() helper function exists in backend/astrology_calc.py
- --save CLI flag accepted by argparse
- Three snapshot file types created: transit-{date}.json, progressions-{date}.json, solar-arc-{date}.json
- Files stored in existing profile directories (~/.natal-charts/{slug}/)
- JSON stdout unaffected (valid JSON even with --save)
- Confirmation to stderr only
- SKILL.md updated with --save routing
- All existing modes pass regression check
</success_criteria>

<output>
After completion, create `.planning/phases/12-snapshot-storage/12-01-SUMMARY.md`
</output>
