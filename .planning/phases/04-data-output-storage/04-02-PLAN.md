---
phase: 04-data-output-storage
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/astrology_calc.py
autonomous: true

must_haves:
  truths:
    - "Chart profiles store in ~/.natal-charts/{slugified-name}/ subfolders automatically"
    - "Each profile contains both chart.json and chart.svg files"
    - "Script lists all existing chart profiles with person names when invoked with --list flag"
    - "Script warns and displays existing birth details before overwriting a profile"
    - "Profile name slugification handles unicode characters correctly"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "Profile management with list, save, overwrite protection"
      contains: "slugify"
    - path: "~/.natal-charts/"
      provides: "Profile storage directory"
  key_links:
    - from: "backend/astrology_calc.py"
      to: "~/.natal-charts/{slug}/chart.json"
      via: "Path.expanduser() + slugify(name)"
      pattern: "expanduser.*slugify"
    - from: "backend/astrology_calc.py"
      to: "python-slugify"
      via: "from slugify import slugify"
      pattern: "from slugify import slugify"
---

<objective>
Add a profile management system that automatically stores chart data in organized per-person subdirectories under ~/.natal-charts/, with listing capability and overwrite protection.

Purpose: Enable persistent chart storage so users can generate a chart once and load it later. Profile listing lets users see available charts. Overwrite protection prevents accidental data loss. Unicode slugification ensures international names create valid directory names.

Output: Modified astrology_calc.py with --list flag for profile listing, automatic profile storage on chart generation (replacing the --output-dir from Plan 01 with ~/.natal-charts/{slug}/ as default), overwrite protection with existing data display, and python-slugify integration for safe directory naming.
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-output-storage/04-RESEARCH.md
@.planning/phases/04-data-output-storage/04-01-SUMMARY.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile storage with slugified directories and overwrite protection</name>
  <files>backend/astrology_calc.py</files>
  <action>
1. Add import at top: `from slugify import slugify`

2. Define constant for base storage directory:
```python
CHARTS_DIR = Path("~/.natal-charts").expanduser()
```

3. Replace the `--output-dir` argument from Plan 01 with automatic profile storage. The script now ALWAYS saves to `~/.natal-charts/{slugified-name}/` when generating a chart. Remove the `--output-dir` argument entirely.

4. Add `--force` flag to skip overwrite confirmation:
```python
parser.add_argument("--force", action="store_true", help="Overwrite existing profile without confirmation")
```

5. Before writing chart files, implement overwrite protection:
```python
def check_existing_profile(profile_dir, person_name):
    """Check if profile exists and display existing data. Returns True if ok to proceed."""
    chart_json = profile_dir / "chart.json"
    if not chart_json.exists():
        return True  # No existing profile, proceed

    # Load and display existing birth details
    import json
    with open(chart_json, 'r', encoding='utf-8') as f:
        existing = json.load(f)

    meta = existing.get('meta', {})
    loc = meta.get('location', {})
    print(f"\nWARNING: Profile '{person_name}' already exists")
    print(f"  Birth date: {meta.get('birth_date', 'Unknown')}")
    print(f"  Birth time: {meta.get('birth_time', 'Unknown')}")
    print(f"  Location:   {loc.get('city', 'N/A')}, {loc.get('nation', 'N/A')}")
    print(f"  Lat/Lng:    {loc.get('latitude', 'N/A')}, {loc.get('longitude', 'N/A')}")
    print(f"  Timezone:   {loc.get('timezone', 'N/A')}")
    print(f"  Generated:  {meta.get('generated_at', 'Unknown')}")
    print()

    # In non-interactive mode (piped input), default to not overwriting
    # For script use, require --force flag
    return False  # Signal that confirmation is needed
```

6. In main(), after building chart_dict and generating SVG, save to profile:
```python
profile_slug = slugify(args.name)
profile_dir = CHARTS_DIR / profile_slug

# Check for existing profile
if not args.force and not check_existing_profile(profile_dir, args.name):
    print("Use --force to overwrite existing profile")
    return 1

# Create directory and save files
profile_dir.mkdir(parents=True, exist_ok=True)

# Write chart.json
chart_json_path = profile_dir / "chart.json"
with open(chart_json_path, 'w', encoding='utf-8') as f:
    json.dump(chart_dict, f, indent=2, ensure_ascii=False)

# Generate SVG into profile directory
# (use same ChartDrawer logic from Plan 01 but target profile_dir)
# ... SVG generation code ...

print(f"\nChart saved to: {profile_dir}")
print(f"  - chart.json")
print(f"  - chart.svg")
```

7. The --force flag bypasses the overwrite check. Without --force, if the profile exists, the script prints the existing data and exits with code 1 telling the user to use --force.

Important: The approach is NON-INTERACTIVE. The script does NOT use input() for confirmation. It prints existing data and tells user to rerun with --force. This is critical because the script will be called from a Claude Code skill which cannot handle interactive prompts.
  </action>
  <verify>
```bash
cd C:/NEW
# First run: creates new profile
python backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin"

# Verify profile created
ls ~/.natal-charts/albert-einstein/
# Should show: chart.json  chart.svg

# Second run: should warn about existing profile
python backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin"
# Should print WARNING with existing birth details and exit with code 1

# Third run: force overwrite
python backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin" --force
# Should succeed and overwrite

# Test unicode slugification
python backend/astrology_calc.py "Jose Garcia" --date 1990-01-01 --time 12:00 --lat 40.4168 --lng -3.7038 --tz "Europe/Madrid"
ls ~/.natal-charts/jose-garcia/
```
  </verify>
  <done>
Charts automatically save to ~/.natal-charts/{slugified-name}/. Existing profiles trigger warning with birth detail display. --force flag bypasses overwrite protection. Unicode names produce valid directory slugs. Each profile has chart.json + chart.svg.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add profile listing with --list flag</name>
  <files>backend/astrology_calc.py</files>
  <action>
1. Add `--list` flag to argparse:
```python
parser.add_argument("--list", action="store_true", help="List all existing chart profiles")
```

2. Make the `name` positional argument optional (required only when not using --list):
   - Change `name` argument: `parser.add_argument("name", nargs="?", help="Person's name")`
   - After parsing, validate: if not args.list and not args.name, show error

3. Add list_profiles() function:
```python
def list_profiles():
    """List all existing chart profiles with person names and birth details."""
    if not CHARTS_DIR.exists():
        print("No chart profiles found")
        print(f"(Directory {CHARTS_DIR} does not exist)")
        return 0

    # Get all profile directories, skip hidden files
    profiles = [
        d for d in CHARTS_DIR.iterdir()
        if d.is_dir() and not d.name.startswith('.')
    ]

    if not profiles:
        print("No chart profiles found")
        return 0

    print(f"Found {len(profiles)} chart profile(s):\n")

    for profile_dir in sorted(profiles):
        chart_json = profile_dir / "chart.json"
        chart_svg = profile_dir / "chart.svg"

        # Display profile slug as header
        print(f"  {profile_dir.name}/")

        # Read chart.json for person details
        if chart_json.exists():
            try:
                with open(chart_json, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                meta = data.get('meta', {})
                loc = meta.get('location', {})
                print(f"    Name:     {meta.get('name', 'Unknown')}")
                print(f"    Born:     {meta.get('birth_date', '?')} at {meta.get('birth_time', '?')}")
                city = loc.get('city')
                nation = loc.get('nation')
                if city and nation:
                    print(f"    Location: {city}, {nation}")
                else:
                    print(f"    Location: {loc.get('latitude', '?')}, {loc.get('longitude', '?')} ({loc.get('timezone', '?')})")
            except (json.JSONDecodeError, KeyError):
                print("    (invalid chart data)")

        # Show file status
        files = []
        if chart_json.exists(): files.append("chart.json")
        if chart_svg.exists(): files.append("chart.svg")
        print(f"    Files:    {', '.join(files) if files else 'none'}")
        print()

    return 0
```

4. In main(), before all other logic, handle --list:
```python
if args.list:
    return list_profiles()

# Validate name is provided for chart generation
if not args.name:
    parser.error("Name is required for chart generation (or use --list to list profiles)")
```

5. Also update the validation for --date and --time: make them required only when not using --list. Move the required=True to validation logic instead of argparse declaration:
```python
# Make date and time not required in argparse (handled manually)
parser.add_argument("--date", type=valid_date, help="Birth date in YYYY-MM-DD format")
parser.add_argument("--time", type=valid_time, help="Birth time in HH:MM format (24-hour)")

# After parsing, if not --list, validate required fields
if not args.list:
    if not args.name:
        parser.error("Name is required for chart generation")
    if not args.date:
        parser.error("--date is required for chart generation")
    if not getattr(args, 'time', None):
        parser.error("--time is required for chart generation")
```

Note: Be careful with `args.time` - the attribute name may conflict with the time module. Use the argparse dest parameter if needed: `dest='birth_time'`.
  </action>
  <verify>
```bash
cd C:/NEW
# Should list existing profiles (at least albert-einstein from Task 1)
python backend/astrology_calc.py --list

# Output should show:
# Found N chart profile(s):
#
#   albert-einstein/
#     Name:     Albert Einstein
#     Born:     1879-03-14 at 11:30
#     Location: 48.4011, 9.9876 (Europe/Berlin)
#     Files:    chart.json, chart.svg

# Verify --list works without name/date/time
python backend/astrology_calc.py --list
echo $?  # Should be 0

# Verify name is still required without --list
python backend/astrology_calc.py --date 1990-01-01 --time 12:00 --lat 40.0 --lng -3.0 --tz "Europe/Madrid" 2>&1
echo $?  # Should be non-zero (error about missing name)

# Verify chart generation still works
python backend/astrology_calc.py "Test Person" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London" --force
ls ~/.natal-charts/test-person/
```
  </verify>
  <done>
--list flag shows all existing profiles with person name, birth date/time, and location from stored chart.json. Profiles display alphabetically by slug. Hidden directories are filtered. Works without requiring name, date, or time arguments. Chart generation still requires all birth data arguments.
  </done>
</task>

</tasks>

<verification>
1. Profile creation: `python backend/astrology_calc.py "Test" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London" --force` creates `~/.natal-charts/test/` with chart.json + chart.svg
2. Overwrite protection: Running same command without --force shows WARNING with existing birth details and exits
3. Force overwrite: Running with --force succeeds
4. Profile listing: `python backend/astrology_calc.py --list` shows all profiles with names and birth details
5. Unicode slugification: Person name with unicode chars creates valid directory slug
6. Hidden file filtering: Profile listing does not show .DS_Store or similar hidden entries
7. JSON integrity: Stored chart.json has all 10 sections (meta, planets, houses, angles, aspects, asteroids, fixed_stars, arabic_parts, dignities, distributions)
8. SVG integrity: Stored chart.svg is valid SVG file
</verification>

<success_criteria>
- [ ] Charts auto-save to ~/.natal-charts/{slugified-name}/ on generation
- [ ] Each profile directory contains chart.json and chart.svg
- [ ] --list flag shows all profiles with person names and birth details
- [ ] Existing profile triggers WARNING with birth detail display (without --force)
- [ ] --force flag bypasses overwrite protection
- [ ] Unicode person names slugify to valid directory names
- [ ] Hidden files/directories excluded from profile listing
- [ ] name argument optional when using --list
- [ ] date and time arguments required only for chart generation (not --list)
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-output-storage/04-02-SUMMARY.md`
</output>
