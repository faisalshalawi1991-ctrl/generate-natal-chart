---
phase: 04-data-output-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/astrology_calc.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Script generates structured JSON file containing all chart data organized by astrological domain"
    - "Script generates SVG natal wheel chart using Kerykeion's ChartDrawer"
    - "JSON includes planets section with sign, degree, house, retrograde status for all 10 planets"
    - "JSON includes houses section with cusp signs and degrees for all 12 houses"
    - "JSON includes aspects section with participating bodies, aspect type, orb, applying/separating"
    - "JSON includes asteroids, fixed stars, Arabic parts, dignities, element/modality distributions"
    - "Both JSON and SVG are generated from same ChartDataModel to avoid recalculation"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "JSON export and SVG generation functions"
      contains: "chart_data.model_dump_json"
    - path: "requirements.txt"
      provides: "python-slugify dependency declaration"
      contains: "python-slugify"
  key_links:
    - from: "backend/astrology_calc.py"
      to: "kerykeion.chart_data_factory.ChartDataFactory"
      via: "create_natal_chart_data(subject)"
      pattern: "ChartDataFactory\\.create_natal_chart_data"
    - from: "backend/astrology_calc.py"
      to: "kerykeion.charts.chart_drawer.ChartDrawer"
      via: "ChartDrawer(chart_data=chart_data)"
      pattern: "ChartDrawer\\(chart_data"
---

<objective>
Build structured JSON export and SVG chart generation from the existing natal chart calculation script.

Purpose: Transform the current print-based output into structured data files (JSON + SVG) that can be stored, loaded into Claude's context, and visually reviewed. This is the foundation for the profile storage system in Plan 02.

Output: Modified astrology_calc.py that generates both chart.json (comprehensive structured data) and chart.svg (visual natal wheel) from a single ChartDataModel computation. Updated requirements.txt with python-slugify dependency (needed by Plan 02, added here to keep dependency management in one place).
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-output-storage/04-RESEARCH.md
@.planning/phases/03-extended-calculations/03-01-SUMMARY.md
@.planning/phases/03-extended-calculations/03-02-SUMMARY.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JSON export with comprehensive chart data structure</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add a function `build_chart_json(subject, args)` that constructs a comprehensive JSON-serializable dictionary from the AstrologicalSubject. The function must build the complete chart data structure from the existing calculation code (not from ChartDataFactory's model_dump - we need our custom structure that includes ALL extended calculations from Phase 3).

The JSON structure must include these top-level sections:

```python
{
  "meta": {
    "name": str,             # Person's name
    "birth_date": str,       # YYYY-MM-DD
    "birth_time": str,       # HH:MM
    "location": {
      "city": str or null,   # From GeoNames mode
      "nation": str or null, # From GeoNames mode
      "latitude": float,
      "longitude": float,
      "timezone": str        # IANA timezone
    },
    "house_system": "Placidus",
    "chart_type": "Day" or "Night",
    "generated_at": str      # ISO 8601 timestamp
  },
  "planets": [
    {
      "name": str,           # "Sun", "Moon", etc.
      "sign": str,           # 3-letter abbreviation
      "degree": float,       # Position within sign (0-30)
      "abs_position": float, # Absolute ecliptic longitude (0-360)
      "house": str,          # House name from Kerykeion
      "retrograde": bool
    }
    # ... all 10 planets
  ],
  "houses": [
    {
      "number": int,         # 1-12
      "sign": str,           # 3-letter abbreviation
      "degree": float        # Cusp position within sign (0-30)
    }
    # ... all 12 houses
  ],
  "angles": [
    {
      "name": str,           # "ASC", "MC", "DSC", "IC"
      "sign": str,
      "degree": float,       # Position within sign
      "abs_position": float  # Absolute ecliptic longitude
    }
  ],
  "aspects": [
    {
      "planet1": str,        # First body name
      "planet2": str,        # Second body name
      "type": str,           # "conjunction", "opposition", "trine", "square", "sextile"
      "orb": float,          # Orb in degrees
      "movement": str        # "applying" or "separating"
    }
  ],
  "asteroids": [
    {
      "name": str,           # "Chiron", "Mean Lilith", etc.
      "sign": str,
      "degree": float,       # Within sign
      "house": str,
      "retrograde": bool
    }
  ],
  "fixed_stars": [
    {
      "star": str,           # Display name
      "conjunct_body": str,  # Planet or angle name
      "orb": float           # Orb in degrees
    }
  ],
  "arabic_parts": {
    "part_of_fortune": {"sign": str, "degree": float},
    "part_of_spirit": {"sign": str, "degree": float}
  },
  "dignities": [
    {
      "planet": str,         # Traditional planet name
      "sign": str,           # Current sign
      "status": [str]        # ["Domicile"], ["Exaltation"], ["Peregrine"], etc.
    }
  ],
  "distributions": {
    "elements": {
      "Fire":    {"count": int, "percentage": float, "planets": [str]},
      "Earth":   {"count": int, "percentage": float, "planets": [str]},
      "Air":     {"count": int, "percentage": float, "planets": [str]},
      "Water":   {"count": int, "percentage": float, "planets": [str]}
    },
    "modalities": {
      "Cardinal": {"count": int, "percentage": float, "planets": [str]},
      "Fixed":    {"count": int, "percentage": float, "planets": [str]},
      "Mutable":  {"count": int, "percentage": float, "planets": [str]}
    }
  }
}
```

This function reuses the EXISTING calculation logic already in main() — extract the computation parts into the function, passing the `subject` and `args`. The function returns a Python dict. Keep the existing print-based output in main() for backward compatibility.

At the end of main(), after all print output, call:
```python
chart_dict = build_chart_json(subject, args)
```

Import `json` at the top. Add `import json` and `from datetime import datetime, timezone` if not present. Use `datetime.now(timezone.utc).isoformat()` for generated_at timestamp.
  </action>
  <verify>
Run: `cd C:/NEW && python backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin"`

Script runs without error. Existing print output still displays. No visible change to user (JSON dict is built internally but not yet written to disk — that's Plan 02).

Add a temporary debug line at end of main() to verify JSON builds: `print(json.dumps(chart_dict, indent=2)[:500])` — then remove it after verification.
  </verify>
  <done>
build_chart_json() function exists and returns a dict with all 10 sections (meta, planets, houses, angles, aspects, asteroids, fixed_stars, arabic_parts, dignities, distributions). All data matches the existing print output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SVG generation and output file writing</name>
  <files>backend/astrology_calc.py, requirements.txt</files>
  <action>
1. Add `--output-dir` optional argument to the argparse parser. When provided, the script writes chart.json and chart.svg to that directory. When not provided, the script behaves exactly as before (print only, no file output).

2. Add SVG generation function using Kerykeion's ChartDrawer. Import at top of file:
```python
from kerykeion.charts.chart_drawer import ChartDrawer
```

After building chart_dict in main(), if `--output-dir` is provided:

a) Create output directory (mkdir parents=True, exist_ok=True)
b) Write chart.json using `json.dump()` with indent=2, ensure_ascii=False, encoding='utf-8'
c) Generate SVG using ChartDrawer:
   - First try: Use ChartDataFactory approach from research:
     ```python
     from kerykeion.chart_data_factory import ChartDataFactory
     chart_data = ChartDataFactory.create_natal_chart_data(subject)
     drawer = ChartDrawer(chart_data=chart_data)
     drawer.save_svg(output_path=output_dir, filename="chart", remove_css_variables=True)
     ```
   - If ChartDataFactory import fails (API may differ in 5.7.2), fall back to:
     ```python
     drawer = ChartDrawer(subject)
     drawer.save_svg(output_path=output_dir, filename="chart")
     ```
   - Wrap in try/except to handle either API gracefully
d) Print confirmation: "Chart files saved to: {output_dir}" and list the files

3. Update requirements.txt to add `python-slugify` (needed by Plan 02, but adding dependency here so requirements stay current). Keep existing `kerykeion==5.7.2` line.

Note on SVG filename: Kerykeion may append its own suffix to the filename. Check what file actually gets created and ensure it's named correctly. If Kerykeion creates `chart_natal_chart.svg` or similar, rename it to `chart.svg` after generation using Path.rename().
  </action>
  <verify>
Run:
```bash
cd C:/NEW
mkdir -p /tmp/test-chart-output
python backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin" --output-dir /tmp/test-chart-output
```

Verify:
1. `/tmp/test-chart-output/chart.json` exists and contains valid JSON with all 10 sections
2. `/tmp/test-chart-output/chart.svg` exists and is valid SVG (check file starts with `<?xml` or `<svg`)
3. JSON has planets array with 10 entries, houses array with 12 entries, aspects array with entries
4. Running without `--output-dir` still works as before (print only, no files created)
5. `requirements.txt` contains both kerykeion==5.7.2 and python-slugify

```bash
python -c "import json; data=json.load(open('/tmp/test-chart-output/chart.json')); print(len(data['planets']), 'planets'); print(len(data['houses']), 'houses'); print(len(data['aspects']), 'aspects'); print(list(data.keys()))"
```
  </verify>
  <done>
--output-dir flag generates chart.json + chart.svg in specified directory. JSON contains all 10 data sections matching Phase 3 calculation output. SVG is a valid natal wheel chart. Script still works without the flag. requirements.txt includes python-slugify.
  </done>
</task>

</tasks>

<verification>
1. Script generates structured JSON: `python backend/astrology_calc.py "Test" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London" --output-dir /tmp/test-chart` produces chart.json
2. JSON schema check: `python -c "import json; d=json.load(open('/tmp/test-chart/chart.json')); assert all(k in d for k in ['meta','planets','houses','angles','aspects','asteroids','fixed_stars','arabic_parts','dignities','distributions']); print('All sections present')"`
3. SVG generation: `/tmp/test-chart/chart.svg` exists and is non-empty
4. Planet count: JSON has exactly 10 planets
5. House count: JSON has exactly 12 houses
6. Backward compatibility: Running without --output-dir produces same print output as before
</verification>

<success_criteria>
- [ ] build_chart_json() returns dict with all 10 astrological data sections
- [ ] --output-dir flag writes chart.json and chart.svg to specified directory
- [ ] JSON planets section has 10 entries with sign, degree, house, retrograde
- [ ] JSON houses section has 12 entries with cusp signs and degrees
- [ ] JSON aspects section has entries with bodies, type, orb, movement
- [ ] JSON includes asteroids, fixed_stars, arabic_parts, dignities, distributions
- [ ] SVG natal wheel chart generated via Kerykeion ChartDrawer
- [ ] requirements.txt updated with python-slugify
- [ ] Running without --output-dir works identically to before
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-output-storage/04-01-SUMMARY.md`
</output>
