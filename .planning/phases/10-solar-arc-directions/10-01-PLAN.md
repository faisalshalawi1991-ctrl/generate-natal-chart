---
phase: 10-solar-arc-directions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/astrology_calc.py]
autonomous: true

must_haves:
  truths:
    - "User can calculate solar arc directions for any target date or age against an existing natal chart profile"
    - "User can see solar arc-to-natal aspects with 1-degree orb, sorted by orb"
    - "User can choose between true arc (default) and mean arc (Naibod) calculation methods"
    - "Directed positions include all 10 major planets plus ASC and MC"
    - "Each aspect shows applying/separating movement"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "Solar arc directions calculation, constants, CLI arguments, routing"
      contains: "SARC_DEFAULT_ORBS"
    - path: "backend/astrology_calc.py"
      provides: "compute_solar_arc function"
      contains: "def compute_solar_arc"
    - path: "backend/astrology_calc.py"
      provides: "build_sarc_aspects function"
      contains: "def build_sarc_aspects"
    - path: "backend/astrology_calc.py"
      provides: "build_solar_arc_json function"
      contains: "def build_solar_arc_json"
    - path: "backend/astrology_calc.py"
      provides: "calculate_solar_arcs function"
      contains: "def calculate_solar_arcs"
  key_links:
    - from: "calculate_solar_arcs"
      to: "load_natal_profile"
      via: "function call to load chart.json"
      pattern: "load_natal_profile\\(args\\.solar_arcs\\)"
    - from: "compute_solar_arc"
      to: "compute_progressed_jd"
      via: "reuse Phase 9 JD arithmetic for true arc"
      pattern: "compute_progressed_jd\\(birth_jd"
    - from: "main()"
      to: "calculate_solar_arcs"
      via: "args.solar_arcs routing before args.progressions"
      pattern: "if args\\.solar_arcs"
---

<objective>
Add solar arc directions calculation to the CLI via `--solar-arcs SLUG`, supporting both true arc (default, using actual progressed Sun position via Swiss Ephemeris) and mean arc (Naibod constant) methods. Compute directed positions for all 10 major planets + ASC/MC, find SA-to-natal aspects within 1-degree orb with applying/separating detection, and output structured JSON to stdout.

Purpose: Enable Claude to analyze solar arc directed charts -- a primary predictive technique in professional astrology where every natal point is advanced by the Sun's progressed arc, revealing major life themes and timing.

Output: Updated `backend/astrology_calc.py` with ~150-200 new lines: 2 constants, 5 new functions, 2 new CLI arguments, routing in main().
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-solar-arc-directions/10-RESEARCH.md
@.planning/phases/09-secondary-progressions/09-01-SUMMARY.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add solar arc constants, functions, CLI arguments, and main() routing</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add all solar arc directions code to backend/astrology_calc.py. This is ~150-200 lines of new code.

**1. Add constants after PROG_DEFAULT_ORBS (around line 106):**

```python
SARC_DEFAULT_ORBS = {
    'conjunction': 1.0,
    'opposition': 1.0,
    'trine': 1.0,
    'square': 1.0,
    'sextile': 1.0,
}

NAIBOD_ARC = 0.98564733  # degrees per year (Sun's mean daily motion)

SARC_ASPECT_ANGLES = {
    'conjunction': 0,
    'opposition': 180,
    'trine': 120,
    'square': 90,
    'sextile': 60,
}

SIGN_OFFSETS = {
    'Ari': 0, 'Tau': 30, 'Gem': 60, 'Can': 90,
    'Leo': 120, 'Vir': 150, 'Lib': 180, 'Sco': 210,
    'Sag': 240, 'Cap': 270, 'Aqu': 300, 'Pis': 330,
}
```

Note: SARC_DEFAULT_ORBS is a plain dict (NOT a list of ActiveAspect objects) because Phase 10 does not use AspectsFactory. SARC_ASPECT_ANGLES maps aspect names to their target angular separations. SIGN_OFFSETS is needed to reconstruct house cusp abs_positions from sign+degree (houses lack abs_position in chart.json).

**2. Add new functions after calculate_progressions() (around line 983, before position_to_sign_degree()):**

**Function: compute_solar_arc(birth_jd, target_jd, natal_sun_lon, method='true')**
- For method='true': call compute_progressed_jd(birth_jd, target_jd) to get progressed JD, then swe.calc_ut(progressed_jd, swe.SUN) to get progressed Sun longitude, return (prog_sun_lon - natal_sun_lon) % 360
- For method='mean': return ((target_jd - birth_jd) / 365.25 * NAIBOD_ARC) % 360
- Reuses compute_progressed_jd() from Phase 9

**Function: angular_distance(lon1, lon2)**
- Compute smallest angular distance: diff = abs(lon1 - lon2) % 360; return 360 - diff if diff > 180 else diff
- Pure geometry helper, no Kerykeion dependency

**Function: build_sarc_aspects(directed_positions, natal_positions, orbs=None)**
- orbs defaults to SARC_DEFAULT_ORBS
- Nested loop: for each directed point, for each natal point
- SKIP self-aspects where directed_point name == natal_point name (per research: self-aspects are redundant)
- For each pair, compute angular_distance(d_lon, n_lon), then for each aspect in SARC_ASPECT_ANGLES check if abs(dist - asp_angle) <= orb for that aspect
- Build aspect dict: directed_point, natal_point, aspect, orb (rounded to 3 decimals)
- Sort result by orb ascending
- Return list of aspect dicts

**Function: build_solar_arc_json(natal_data, slug, birth_jd, target_jd, arc, arc_method)**
- Compute elapsed_years = (target_jd - birth_jd) / 365.25
- Compute target_date string from swe.revjul(target_jd)
- Build meta section: natal_name, natal_slug, target_date, arc_degrees (round to 3), arc_method, elapsed_years (round to 2), chart_type="solar_arc_directions", calculated_at (UTC ISO), orbs_used from SARC_DEFAULT_ORBS
- Extract natal planet positions: {p['name']: p['abs_position'] for p in natal_data['planets'] if p['name'] in MAJOR_PLANETS}
- Extract natal angle positions: {a['name']: a['abs_position'] for a in natal_data['angles'] if a['name'] in ['ASC', 'MC']}
- Combine: all_natal = {**natal_planets, **natal_angles}
- Compute directed positions: {name: (lon + arc) % 360 for name, lon in all_natal.items()}
- Build directed_planets list: for each planet in MAJOR_PLANETS order, include name, natal_sign/degree (from natal_data), natal_abs_position, directed_abs_position, directed_sign/degree (using position_to_sign_degree())
- Build directed_angles list: for ASC and MC, include name, natal_abs_position, directed_abs_position, directed_sign/degree
- Compute aspects via build_sarc_aspects(directed_positions, all_natal)
- Add applying/separating to each aspect: compute arc_future = compute_solar_arc(birth_jd, target_jd + 365.25, natal_sun_lon, method). For each aspect, compute directed_lon_future = (natal_lon_of_directed_point + arc_future) % 360, compute orb_future = abs(angular_distance(directed_lon_future, natal_lon_of_natal_point) - asp_angle), if orb_future < current orb then "Applying" else "Separating"
- Return complete dict with meta, directed_planets, directed_angles, aspects

**Function: calculate_solar_arcs(args)**
- Follow the Phase 9 calculate_progressions() pattern exactly
- Call load_natal_profile(args.solar_arcs) -- returns (subject, natal_data) tuple
- Extract birth_date, birth_time from natal_data['meta']
- Compute birth_jd via swe.julday()
- Determine target_jd: if args.age is not None and args.target_date is not None: error both provided (exit 1). If args.age: target_jd = birth_jd + args.age * 365.25. If args.target_date: swe.julday(). Else: today UTC noon.
- Get natal Sun longitude: next(p['abs_position'] for p in natal_data['planets'] if p['name'] == 'Sun')
- Get arc_method from args.arc_method (default 'true')
- Compute arc = compute_solar_arc(birth_jd, target_jd, natal_sun_lon, method=arc_method)
- Build JSON via build_solar_arc_json()
- Print JSON to stdout, return 0
- Wrap in try/except: FileNotFoundError -> stderr + return 1, Exception -> stderr + return 1

**3. Add CLI arguments in main() (after --prog-year, around line 1562):**

```python
parser.add_argument(
    '--solar-arcs',
    metavar='SLUG',
    dest='solar_arcs',
    help='Calculate solar arc directions for an existing chart profile'
)
parser.add_argument(
    '--arc-method',
    choices=['true', 'mean'],
    default='true',
    dest='arc_method',
    help='Solar arc method: true (default, actual progressed Sun) or mean (Naibod constant)'
)
```

Do NOT redefine --target-date or --age (already defined in Phase 9, shared via args namespace).

**4. Add routing in main() BEFORE --progressions check (after --list, before --progressions):**

```python
# Handle --solar-arcs flag (MUST come before --progressions, --timeline, --transits)
if args.solar_arcs:
    return calculate_solar_arcs(args)
```

This follows the research recommendation: newer modes route before older modes. Order becomes: --list -> --solar-arcs -> --progressions -> --timeline -> --transits -> natal validation.
  </action>
  <verify>
Run these commands (all should exit 0 and produce valid JSON):

```bash
# Test 1: True arc (default) for Einstein at today's date
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --solar-arcs albert-einstein

# Test 2: Mean arc method
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --solar-arcs albert-einstein --arc-method mean

# Test 3: Age-based target
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --solar-arcs albert-einstein --age 30

# Test 4: Specific target date
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --solar-arcs albert-einstein --target-date 2026-02-17

# Test 5: Non-existent profile (should error, exit 1)
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --solar-arcs nonexistent-person; echo "Exit: $?"

# Test 6: Existing modes still work (no regressions)
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --list
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits albert-einstein
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --progressions albert-einstein
```

Verify in solar arcs JSON output:
- meta.chart_type == "solar_arc_directions"
- meta.arc_method is "true" or "mean" as specified
- meta.arc_degrees is a reasonable float (e.g., ~141 for Einstein true arc at 2026)
- directed_planets has 10 entries (one per MAJOR_PLANETS)
- directed_angles has 2 entries (ASC and MC)
- aspects list is non-empty, each has directed_point, natal_point, aspect, orb, movement
- No self-aspects (directed_point != natal_point in same entry)
- All orb values <= 1.0
  </verify>
  <done>
Solar arc directions calculation works for true and mean arc methods, outputs valid JSON with directed planet/angle positions and SA-to-natal aspects within 1-degree orb. Existing CLI modes (--list, --transits, --timeline, --progressions) still work without regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end solar arc verification against research reference values</name>
  <files>backend/astrology_calc.py</files>
  <action>
Verify solar arc output against the research-documented reference values. This task is verification-only; no code changes expected unless a bug is found.

**Verification 1: Einstein true arc at 2026-02-17**
- Run: `--solar-arcs albert-einstein --target-date 2026-02-17`
- Expected: arc_degrees approximately 141.9 (research says 141.935)
- Expected: elapsed_years approximately 146.93
- Expected: aspects list should contain ~6 aspects within 1-degree orb (research verified 6)
- Expected: directed Sun should be in Leo ~15 degrees (natal Sun Pis 23.5 + arc ~142)

**Verification 2: Einstein mean arc at 2026-02-17**
- Run: `--solar-arcs albert-einstein --target-date 2026-02-17 --arc-method mean`
- Expected: arc_degrees approximately 144.8 (research says 144.821)
- Expected: arc_degrees should differ from true arc by ~2.9 degrees

**Verification 3: Einstein age 30**
- Run: `--solar-arcs albert-einstein --age 30`
- Expected: arc_degrees approximately 29-30 degrees (roughly 1 degree per year)
- Expected: elapsed_years = 30.00

**Verification 4: Self-aspect exclusion**
- In any output, verify NO aspect has directed_point == natal_point

**Verification 5: Movement field**
- Every aspect must have a "movement" field with value "Applying" or "Separating"

**Verification 6: No regressions**
- Run natal chart creation: `--force "Test Regression" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London"`
- Run --list
- Run --transits albert-einstein
- Run --timeline albert-einstein --preset week
- Run --progressions albert-einstein
- All must exit 0

If any verification fails, diagnose and fix the issue in astrology_calc.py before marking complete.
  </action>
  <verify>
All 6 verification checks pass. Reference values from research match within reasonable tolerance (arc_degrees within 1.0 of expected, aspect counts reasonable). No regressions in any existing CLI mode.
  </verify>
  <done>
Solar arc directions verified against research reference values (Einstein true/mean arc, age-based lookup). Self-aspect exclusion confirmed. Applying/separating movement present on all aspects. Zero regressions across all existing CLI modes.
  </done>
</task>

</tasks>

<verification>
Phase 10 is complete when:
1. `--solar-arcs SLUG` produces valid JSON with directed positions and aspects (SARC-01)
2. Aspects use 1-degree orb with applying/separating detection (SARC-02)
3. `--arc-method true` and `--arc-method mean` produce different arc values (SARC-03)
4. Existing modes (--list, --transits, --timeline, --progressions, natal creation) have zero regressions
5. Reference values from research match within tolerance
</verification>

<success_criteria>
- calculate_solar_arcs() function exists and routes correctly from main()
- compute_solar_arc() returns true arc via swe.calc_ut and mean arc via NAIBOD_ARC constant
- build_sarc_aspects() finds aspects manually (no AspectsFactory) with self-aspect exclusion
- JSON output includes meta, directed_planets (10), directed_angles (2), and aspects sections
- Einstein true arc ~141.9 degrees, mean arc ~144.8 degrees at 2026-02-17
- All aspects have orb <= 1.0 and movement field
</success_criteria>

<output>
After completion, create `.planning/phases/10-solar-arc-directions/10-01-SUMMARY.md`
</output>
