---
phase: 03-extended-calculations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/astrology_calc.py]
autonomous: true

must_haves:
  truths:
    - "Script displays asteroid positions (Chiron, Mean Lilith, True Lilith, Ceres, Pallas, Juno, Vesta) with sign and degree"
    - "Script displays Arabic Parts (Part of Fortune, Part of Spirit) with correct day/night formula"
    - "Script displays essential dignities for each traditional planet (Sun through Saturn)"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "Asteroids, Arabic Parts, and Essential Dignities output sections"
      contains: "ASTEROIDS"
    - path: "backend/astrology_calc.py"
      provides: "Arabic Parts with day/night chart detection"
      contains: "ARABIC PARTS"
    - path: "backend/astrology_calc.py"
      provides: "Essential dignities lookup for traditional planets"
      contains: "ESSENTIAL DIGNITIES"
  key_links:
    - from: "backend/astrology_calc.py (asteroids section)"
      to: "subject.chiron, subject.ceres, etc."
      via: "Kerykeion AstrologicalSubject attributes"
      pattern: "subject\\.(chiron|ceres|pallas|juno|vesta|mean_lilith|true_lilith)"
    - from: "backend/astrology_calc.py (arabic parts)"
      to: "subject.sun.house for day/night detection"
      via: "House-based chart type determination"
      pattern: "subject\\.sun\\.house"
    - from: "backend/astrology_calc.py (dignities)"
      to: "DIGNITIES lookup dict"
      via: "Planet sign matched against dignity table"
      pattern: "DIGNITIES\\["
---

<objective>
Add asteroid positions, Arabic parts calculations, and essential dignities to the natal chart output.

Purpose: Extends the core chart with advanced astrological data that astrologers expect for deep interpretation -- asteroid placements reveal feminine archetypes and wounded healer themes, Arabic parts show fortune/spirit axes, and dignities reveal planetary strength.
Output: Updated backend/astrology_calc.py with three new output sections after the existing MAJOR ASPECTS section.
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-extended-calculations/03-RESEARCH.md
@.planning/phases/02-core-calculation-engine/02-01-SUMMARY.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add asteroid positions output section</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add an ASTEROIDS output section after the existing MAJOR ASPECTS section (after line 296, before `return 0`).

Access asteroid positions via Kerykeion's built-in attributes on the `subject` object:
- subject.chiron, subject.mean_lilith, subject.true_lilith, subject.ceres, subject.pallas, subject.juno, subject.vesta

Build an asteroids list similar to the existing `planets` list pattern (lines 243-249):
```python
asteroids = [
    ('Chiron', subject.chiron),
    ('Mean Lilith', subject.mean_lilith),
    ('True Lilith', subject.true_lilith),
    ('Ceres', subject.ceres),
    ('Pallas', subject.pallas),
    ('Juno', subject.juno),
    ('Vesta', subject.vesta),
]
```

Print header `=== ASTEROIDS ===` and iterate, displaying each asteroid's sign, degree within sign (position % 30), and house. Use the same formatting pattern as the planetary positions section (line 254). Include retrograde status using `getattr(body, 'retrograde', False)` for safety (same pattern as line 251).

IMPORTANT: First run the existing script with test data to verify the actual format of `planet.sign` (full name like 'Aries' vs abbreviation like 'Ari'). This determines the key format for lookup tables in later tasks. Print the sign value to confirm. If signs are full names, use full names in all subsequent lookup tables.
  </action>
  <verify>
Run: `cd C:/NEW && python backend/astrology_calc.py "Test Person" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London"`

Confirm:
1. Output includes `=== ASTEROIDS ===` section
2. All 7 asteroids listed (Chiron, Mean Lilith, True Lilith, Ceres, Pallas, Juno, Vesta)
3. Each shows sign name, degree (0-30 range), and house number
4. No AttributeError or crashes
  </verify>
  <done>Seven asteroid positions display with sign, degree, and house. Output format matches existing planetary positions section style.</done>
</task>

<task type="auto">
  <name>Task 2: Add Arabic Parts calculation with day/night detection</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add an ARABIC PARTS output section after the ASTEROIDS section.

Step 1 - Day/night chart detection:
Determine if chart is day or night using Sun's house position. Day chart = Sun in houses 7-12 (above horizon). Night chart = Sun in houses 1-6 (below horizon). Access via `subject.sun.house`. Note: Kerykeion's house attribute may be a string or int -- handle both by converting to int.

Step 2 - Calculate Part of Fortune (Pars Fortunae):
- Day formula: (ASC + Moon - Sun) % 360
- Night formula: (ASC + Sun - Moon) % 360
Get absolute positions from: subject.ascendant.position, subject.moon.position, subject.sun.position

Step 3 - Calculate Part of Spirit (Pars Spiritus):
- Day formula: (ASC + Sun - Moon) % 360 (reverse of Fortune day formula)
- Night formula: (ASC + Moon - Sun) % 360

Step 4 - Convert positions to sign and degree:
Create a helper function `position_to_sign_degree(position)` that converts 0-360 absolute longitude to (sign_name, degree_within_sign). Use the sign list: ['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces']. sign_index = int(position // 30), degree = position % 30.

NOTE: If Task 1 revealed that Kerykeion uses abbreviated sign names (e.g., 'Ari'), adjust the sign list accordingly. Most likely Kerykeion uses full names.

Display: Chart type (Day/Night), Part of Fortune with sign and degree, Part of Spirit with sign and degree.
  </action>
  <verify>
Run: `cd C:/NEW && python backend/astrology_calc.py "Test Person" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London"`

Confirm:
1. Output includes `=== ARABIC PARTS ===` section
2. Chart type shown as either "Day" or "Night"
3. Part of Fortune displays with sign and degree (0-30 range)
4. Part of Spirit displays with sign and degree (0-30 range)
5. Both positions are valid zodiac signs and degree values
  </verify>
  <done>Arabic Parts section displays chart type, Part of Fortune, and Part of Spirit with correct sign and degree. Day/night formula correctly applied based on Sun's house position.</done>
</task>

<task type="auto">
  <name>Task 3: Add essential dignities for traditional planets</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add an ESSENTIAL DIGNITIES output section after the ARABIC PARTS section.

Step 1 - Define the DIGNITIES lookup table as a module-level constant (above the main() function) for the 7 traditional planets (Sun through Saturn). Use the complete table from research:

```python
DIGNITIES = {
    'Sun': {'domicile': ['Leo'], 'exaltation': ['Aries'], 'detriment': ['Aquarius'], 'fall': ['Libra']},
    'Moon': {'domicile': ['Cancer'], 'exaltation': ['Taurus'], 'detriment': ['Capricorn'], 'fall': ['Scorpio']},
    'Mercury': {'domicile': ['Gemini', 'Virgo'], 'exaltation': ['Virgo'], 'detriment': ['Sagittarius', 'Pisces'], 'fall': ['Pisces']},
    'Venus': {'domicile': ['Taurus', 'Libra'], 'exaltation': ['Pisces'], 'detriment': ['Scorpio', 'Aries'], 'fall': ['Virgo']},
    'Mars': {'domicile': ['Aries', 'Scorpio'], 'exaltation': ['Capricorn'], 'detriment': ['Libra', 'Taurus'], 'fall': ['Cancer']},
    'Jupiter': {'domicile': ['Sagittarius', 'Pisces'], 'exaltation': ['Cancer'], 'detriment': ['Gemini', 'Virgo'], 'fall': ['Capricorn']},
    'Saturn': {'domicile': ['Capricorn', 'Aquarius'], 'exaltation': ['Libra'], 'detriment': ['Cancer', 'Leo'], 'fall': ['Aries']},
}
```

IMPORTANT: The dictionary keys for sign names MUST match Kerykeion's actual output format (verified in Task 1). If Kerykeion returns 'Aries' (full names), use full names. Do NOT use abbreviations unless confirmed.

Step 2 - Create a `get_planet_dignities(planet_name, planet_sign)` helper function (above main()) that:
- Returns list of dignity strings for the planet in given sign
- Checks domicile, exaltation, detriment, fall
- Returns ['Peregrine'] if no dignity found
- Returns empty list for planets not in DIGNITIES (outer planets)

Step 3 - Display section:
Iterate over the 7 traditional planets (Sun, Moon, Mercury, Venus, Mars, Jupiter, Saturn) from the existing `planets` list. For each, call get_planet_dignities() with the planet's sign attribute. Print planet name, sign, and dignity status.

Add a note: "Traditional planets only (Sun-Saturn). Modern planet dignities (Uranus, Neptune, Pluto) are disputed and excluded."
  </action>
  <verify>
Run: `cd C:/NEW && python backend/astrology_calc.py "Test Person" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London"`

Confirm:
1. Output includes `=== ESSENTIAL DIGNITIES ===` section
2. All 7 traditional planets listed with their sign and dignity status
3. Each planet shows at least one status (Domicile, Exaltation, Detriment, Fall, or Peregrine)
4. Note about traditional planets only is displayed
5. No KeyError on sign lookups (format matches Kerykeion output)
  </verify>
  <done>Essential dignities section displays all 7 traditional planets with correct dignity status based on their sign placement. Sign name format matches Kerykeion output. Outer planets excluded with explanatory note.</done>
</task>

</tasks>

<verification>
Run the full script and confirm all three new sections appear in order after MAJOR ASPECTS:
1. ASTEROIDS (7 bodies with sign, degree, house)
2. ARABIC PARTS (chart type + Part of Fortune + Part of Spirit)
3. ESSENTIAL DIGNITIES (7 traditional planets with dignity status)

All existing output (planetary positions, houses, angles, aspects) must be unchanged.
</verification>

<success_criteria>
- Script runs without errors for test birth data
- 7 asteroids display with sign, degree, and house
- Arabic Parts show correct day/night detection and two parts with sign/degree
- Essential dignities show all 7 traditional planets with at least one dignity status each
- No regressions in existing output sections
</success_criteria>

<output>
After completion, create `.planning/phases/03-extended-calculations/03-01-SUMMARY.md`
</output>
