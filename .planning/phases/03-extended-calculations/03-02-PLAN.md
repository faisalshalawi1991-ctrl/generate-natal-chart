---
phase: 03-extended-calculations
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [backend/astrology_calc.py]
autonomous: true

must_haves:
  truths:
    - "Script displays fixed star conjunctions to planets and angles using 1-degree orb"
    - "Script displays element distribution (fire, earth, air, water) across all placements"
    - "Script displays modality distribution (cardinal, fixed, mutable) across all placements"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "Fixed star conjunction detection via pyswisseph"
      contains: "FIXED STAR CONJUNCTIONS"
    - path: "backend/astrology_calc.py"
      provides: "Element distribution counting"
      contains: "ELEMENT DISTRIBUTION"
    - path: "backend/astrology_calc.py"
      provides: "Modality distribution counting"
      contains: "MODALITY DISTRIBUTION"
  key_links:
    - from: "backend/astrology_calc.py (fixed stars)"
      to: "swisseph.fixstar2_ut()"
      via: "pyswisseph direct call for star positions"
      pattern: "swe\\.fixstar2_ut"
    - from: "backend/astrology_calc.py (fixed stars)"
      to: "planets and angles lists"
      via: "Comparing star longitude to planet/angle positions"
      pattern: "planet.*position.*star"
    - from: "backend/astrology_calc.py (distributions)"
      to: "ELEMENT_MAP and MODALITY_MAP lookup dicts"
      via: "Planet sign matched against zodiac element/modality"
      pattern: "(ELEMENT_MAP|MODALITY_MAP)\\["
---

<objective>
Add fixed star conjunction detection, element distribution, and modality distribution to the natal chart output.

Purpose: Fixed star conjunctions reveal powerful archetypal influences from bright stars overlaying planet/angle positions. Element and modality distributions reveal the overall temperament balance of the chart -- whether a person is fire-dominant (action), earth-dominant (practical), etc., and whether they are cardinal (initiating), fixed (sustaining), or mutable (adapting).
Output: Updated backend/astrology_calc.py with three new output sections completing all Phase 3 requirements.
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-extended-calculations/03-RESEARCH.md
@.planning/phases/03-extended-calculations/03-01-SUMMARY.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fixed star conjunction detection via pyswisseph</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add a FIXED STAR CONJUNCTIONS output section after the ESSENTIAL DIGNITIES section.

Step 1 - Add import at top of file:
```python
import swisseph as swe
```
pyswisseph is already installed as a transitive dependency of Kerykeion. No new pip install needed.

Step 2 - Define MAJOR_STARS list as a module-level constant (near the DIGNITIES table):
```python
MAJOR_STARS = [
    'Aldebaran',    # Eye of the Bull, ~9 Gem
    'Rigel',        # Foot of Orion, ~16 Gem
    'Sirius',       # Dog Star, brightest, ~14 Can
    'Castor',       # Alpha Geminorum, ~20 Can
    'Pollux',       # Beta Geminorum, ~23 Can
    'Regulus',      # Heart of the Lion, ~0 Vir
    'Spica',        # Wheat Ear of Virgo, ~24 Lib
    'Arcturus',     # Bear Watcher, ~24 Lib
    'Antares',      # Heart of Scorpion, ~9 Sag
    'Vega',         # Alpha Lyrae, ~15 Cap
    'Altair',       # Alpha Aquilae, ~1 Aqu
    'Fomalhaut',    # Royal Star, ~3 Pis
    'Algol',        # Demon Star, ~26 Tau
]
```
These are 13 historically significant stars (magnitude 1-2, used in classical astrology).

Step 3 - Calculate Julian day for the birth data:
```python
jd = swe.julday(args.date.year, args.date.month, args.date.day,
                args.time.hour + args.time.minute / 60.0)
```

Step 4 - Build points_to_check list combining all 10 planets and 4 angles:
```python
points_to_check = [(name, p.position) for name, p in planets] + \
                  [(name, a.position) for name, a in angles]
```
This reuses the existing `planets` and `angles` lists already defined earlier in the function.

Step 5 - For each star in MAJOR_STARS, call `swe.fixstar2_ut(star_name, jd, 0)`. Extract star_longitude from result[0][0]. Compare against each point with 1-degree orb. Handle zodiac wrap-around:
```python
diff = abs(point_long - star_long)
if diff > 180:
    diff = 360 - diff
```

Step 6 - Wrap each star calculation in try/except to handle missing stars gracefully (print warning to stderr, continue).

Step 7 - Display results: Print header `=== FIXED STAR CONJUNCTIONS (orb <= 1.0 deg) ===`. If conjunctions found, print each as `{star_name} conjunct {point_name} (orb: {diff:.2f} deg)`. If none found, print "No major fixed star conjunctions detected".

PITFALL TO AVOID: swe.fixstar2_ut returns a tuple (result_tuple, return_flag). The longitude is at result_tuple[0]. Do NOT index as result[0] -- it should be `star_data, ret_flag = swe.fixstar2_ut(...)` then `star_long = star_data[0]`.
  </action>
  <verify>
Run: `cd C:/NEW && python backend/astrology_calc.py "Test Person" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London"`

Confirm:
1. Output includes `=== FIXED STAR CONJUNCTIONS ===` section
2. No import errors for swisseph
3. Either conjunctions are listed OR "No major fixed star conjunctions detected" appears
4. No crashes from missing star names or calculation errors
5. If conjunctions found, orb values are between 0 and 1.0

Also test with a known conjunction case:
Run: `cd C:/NEW && python backend/astrology_calc.py "Regulus Test" --date 1990-08-23 --time 12:00 --lat 51.5074 --lng -0.1278 --tz "Europe/London"`
(Sun near 0 Virgo should be close to Regulus at ~0 Virgo)
  </verify>
  <done>Fixed star conjunction section detects and displays conjunctions between 13 major stars and all planets/angles using 1-degree orb. Missing stars handled gracefully. Zodiac wrap-around handled correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Add element and modality distribution sections</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add ELEMENT DISTRIBUTION and MODALITY DISTRIBUTION output sections after the FIXED STAR CONJUNCTIONS section.

Step 1 - Define lookup tables as module-level constants (near DIGNITIES and MAJOR_STARS):

ELEMENT_MAP: Map each zodiac sign to its element. Keys MUST match Kerykeion's sign format (confirmed by Plan 01 Task 1 -- almost certainly full names like 'Aries'):
```python
ELEMENT_MAP = {
    'Aries': 'Fire', 'Leo': 'Fire', 'Sagittarius': 'Fire',
    'Taurus': 'Earth', 'Virgo': 'Earth', 'Capricorn': 'Earth',
    'Gemini': 'Air', 'Libra': 'Air', 'Aquarius': 'Air',
    'Cancer': 'Water', 'Scorpio': 'Water', 'Pisces': 'Water',
}
```

MODALITY_MAP: Map each zodiac sign to its modality:
```python
MODALITY_MAP = {
    'Aries': 'Cardinal', 'Cancer': 'Cardinal', 'Libra': 'Cardinal', 'Capricorn': 'Cardinal',
    'Taurus': 'Fixed', 'Leo': 'Fixed', 'Scorpio': 'Fixed', 'Aquarius': 'Fixed',
    'Gemini': 'Mutable', 'Virgo': 'Mutable', 'Sagittarius': 'Mutable', 'Pisces': 'Mutable',
}
```

Step 2 - Collect placements: 10 planets + ASC (11 total). Build from the existing `planets` list plus ascendant:
```python
placements = [(name, p) for name, p in planets] + [('ASC', subject.ascendant)]
```

Step 3 - Count elements:
```python
element_count = {'Fire': 0, 'Earth': 0, 'Air': 0, 'Water': 0}
for name, body in placements:
    element = ELEMENT_MAP.get(body.sign)
    if element:
        element_count[element] += 1
```

Step 4 - Count modalities similarly with MODALITY_MAP.

Step 5 - Display element distribution:
Print header `=== ELEMENT DISTRIBUTION ===`. Print total count (should be 11). For each element, print count and percentage. Also print which planets are in each element for interpretive value (e.g., "Fire (3): Sun, Mars, Jupiter").

Step 6 - Display modality distribution:
Print header `=== MODALITY DISTRIBUTION ===`. Same format as elements -- count, percentage, and planet names per modality.

Including planet names per category makes the distribution immediately interpretive rather than just numbers, which is critical for the astrologer guide prompt in Phase 6.
  </action>
  <verify>
Run: `cd C:/NEW && python backend/astrology_calc.py "Test Person" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London"`

Confirm:
1. Output includes `=== ELEMENT DISTRIBUTION ===` section
2. Output includes `=== MODALITY DISTRIBUTION ===` section
3. Four elements shown (Fire, Earth, Air, Water) with counts totaling 11
4. Three modalities shown (Cardinal, Fixed, Mutable) with counts totaling 11
5. Percentages are reasonable (each between 0-100%, sum ~100%)
6. Planet names listed per category
7. No KeyError on sign lookups
  </verify>
  <done>Element distribution shows all 4 elements with counts, percentages, and planet names. Modality distribution shows all 3 modalities with counts, percentages, and planet names. Counts based on 10 planets + ASC (11 placements total).</done>
</task>

</tasks>

<verification>
Run the full script and confirm ALL Phase 3 output sections appear in order after MAJOR ASPECTS:
1. ASTEROIDS (7 bodies)
2. ARABIC PARTS (chart type + 2 parts)
3. ESSENTIAL DIGNITIES (7 traditional planets)
4. FIXED STAR CONJUNCTIONS (13 stars checked)
5. ELEMENT DISTRIBUTION (4 elements, 11 placements)
6. MODALITY DISTRIBUTION (3 modalities, 11 placements)

All Phase 2 output (planetary positions, houses, angles, aspects) must be unchanged.

Verify ALL 6 Phase 3 success criteria from ROADMAP.md:
1. Asteroid positions by sign and degree -- ASTEROIDS section
2. Fixed star conjunctions to planets and angles -- FIXED STAR CONJUNCTIONS section
3. Arabic parts (Part of Fortune, Part of Spirit) -- ARABIC PARTS section
4. Essential dignities per planet -- ESSENTIAL DIGNITIES section
5. Element distribution -- ELEMENT DISTRIBUTION section
6. Modality distribution -- MODALITY DISTRIBUTION section
</verification>

<success_criteria>
- Script runs without errors for test birth data
- Fixed star conjunctions detected with 1-degree orb (or "none detected" message)
- Element distribution shows 4 elements with counts totaling 11
- Modality distribution shows 3 modalities with counts totaling 11
- All 6 Phase 3 ROADMAP success criteria met across both plans
- No regressions in any existing output sections
</success_criteria>

<output>
After completion, create `.planning/phases/03-extended-calculations/03-02-SUMMARY.md`
</output>
