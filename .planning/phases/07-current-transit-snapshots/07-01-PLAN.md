---
phase: 07-current-transit-snapshots
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/astrology_calc.py
autonomous: true

must_haves:
  truths:
    - "User can run --transits SLUG and get transit positions for today (UTC) against their natal chart"
    - "User can run --transits SLUG --query-date YYYY-MM-DD for any date in 1900-2100 range"
    - "Transit-to-natal aspects show with configurable default orbs (conjunction/opposition 3, trine/square 2, sextile 1)"
    - "Each transit planet shows which natal house it currently occupies"
    - "Each transit planet shows retrograde status (true/false)"
    - "Each transit aspect shows applying or separating movement"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "Transit snapshot calculation with CLI interface"
      contains: "def valid_query_date"
    - path: "backend/astrology_calc.py"
      provides: "Natal profile loading and reconstruction"
      contains: "def load_natal_profile"
    - path: "backend/astrology_calc.py"
      provides: "Transit JSON assembly"
      contains: "def build_transit_json"
    - path: "backend/astrology_calc.py"
      provides: "Transit orchestration"
      contains: "def calculate_transits"
  key_links:
    - from: "main() --transits branch"
      to: "calculate_transits()"
      via: "early return before natal validation"
      pattern: "args\\.transits.*calculate_transits"
    - from: "calculate_transits()"
      to: "load_natal_profile()"
      via: "loads chart.json and reconstructs AstrologicalSubject"
      pattern: "load_natal_profile.*slug"
    - from: "calculate_transits()"
      to: "AspectsFactory.dual_chart_aspects()"
      via: "transit-to-natal aspect calculation"
      pattern: "dual_chart_aspects"
    - from: "calculate_transits()"
      to: "HouseComparisonFactory"
      via: "natal house placement for transit planets"
      pattern: "HouseComparisonFactory"
    - from: "calculate_transits()"
      to: "stdout JSON output"
      via: "json.dumps of transit dict"
      pattern: "json\\.dumps.*transit"
---

<objective>
Add transit snapshot calculation mode to the astrology CLI. Users run `--transits SLUG` (with optional `--query-date`) to calculate current transit planet positions, their aspects to natal chart planets, natal house placements, retrograde status, and applying/separating aspect movement. Output is transit JSON printed to stdout.

Purpose: This is the foundation of v1.1 — all subsequent phases (timelines, progressions, solar arcs) build on the transit calculation pattern established here.
Output: Modified `backend/astrology_calc.py` with 4 new functions and updated CLI argument parsing (~120-150 LOC added).
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/NEW/.planning/PROJECT.md
@C:/NEW/.planning/ROADMAP.md
@C:/NEW/.planning/STATE.md
@C:/NEW/.planning/phases/07-current-transit-snapshots/07-RESEARCH.md
@C:/NEW/backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transit snapshot functions and CLI arguments</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add 4 new functions and update CLI argument parsing in `backend/astrology_calc.py`. All new code is ADDITIVE — do NOT modify any existing functions (build_chart_json, valid_date, valid_time, list_profiles, etc.).

**New imports** (add alongside existing imports at top of file):
```python
from kerykeion.aspects.aspects_factory import AspectsFactory
from kerykeion.house_comparison.house_comparison_factory import HouseComparisonFactory
from kerykeion.schemas.kr_models import ActiveAspect
```

**New constant** (add after existing constants, before first function definition):
```python
TRANSIT_DEFAULT_ORBS = [
    ActiveAspect(name='conjunction', orb=3),
    ActiveAspect(name='opposition', orb=3),
    ActiveAspect(name='trine', orb=2),
    ActiveAspect(name='square', orb=2),
    ActiveAspect(name='sextile', orb=1),
]

MAJOR_PLANETS = [
    'Sun', 'Moon', 'Mercury', 'Venus', 'Mars',
    'Jupiter', 'Saturn', 'Uranus', 'Neptune', 'Pluto'
]
```

**Function 1: `valid_query_date(s)`** — Add after `valid_date()`. Validates YYYY-MM-DD format with 1900-2100 range (NOT the same as `valid_date` which caps at current year). Raises `argparse.ArgumentTypeError` on failure. Returns datetime.

**Function 2: `load_natal_profile(slug)`** — Add after validators. Loads `~/.natal-charts/{slug}/chart.json`, parses meta fields (name, birth_date, birth_time, location.latitude, location.longitude, location.timezone), reconstructs `AstrologicalSubject` using `AstrologicalSubjectFactory.from_birth_data()` with `online=False` and `houses_system_identifier='P'`. Returns tuple of `(subject, profile_data_dict)`. Raises `FileNotFoundError` if profile not found, `SystemExit(1)` with stderr message for parse errors.

**Function 3: `build_transit_json(transit_subject, natal_subject, natal_data, query_date_str, slug)`** — Add after `load_natal_profile`. Creates the transit snapshot JSON dict with this structure:
- `meta`: natal_name, natal_slug, query_date, query_time_utc, chart_type="transit_snapshot", calculated_at (ISO UTC), orbs_used dict
- `transit_planets`: list of 10 planets with name, sign, degree (abs_pos % 30 rounded to 2 decimals), abs_position (rounded to 4 decimals), retrograde (bool from planet.retrograde), natal_house (int from HouseComparisonFactory)
- `transit_aspects`: list from `AspectsFactory.dual_chart_aspects(transit_subject, natal_subject, active_aspects=TRANSIT_DEFAULT_ORBS, active_points=MAJOR_PLANETS)` with transit_planet (p1_name), natal_planet (p2_name), aspect, orb (rounded to 2), applying (bool: movement == 'Applying'), movement (string)

For house placement: use `HouseComparisonFactory(transit_subject, natal_subject, active_points=MAJOR_PLANETS).get_house_comparison()` and map `first_points_in_second_houses` items by `point_name` to `projected_house_number`.

**Function 4: `calculate_transits(args)`** — Add after `build_transit_json`. Orchestrates the full flow:
1. Call `load_natal_profile(args.transits)` to get natal subject and data
2. Determine query date: if `args.query_date` is set, use it at UTC noon (hour=12, minute=0); otherwise use `datetime.now(timezone.utc)` for current moment
3. Create transit subject with `AstrologicalSubjectFactory.from_birth_data(name='Current Transits', year=..., month=..., day=..., hour=..., minute=..., lat=0.0, lng=0.0, tz_str='UTC', online=False, houses_system_identifier='P')`
4. Call `build_transit_json(...)` to assemble the dict
5. Print `json.dumps(transit_dict, indent=2)` to stdout
6. Return 0 on success, 1 on error (wrap in try/except, print errors to stderr)

**CLI argument additions** (in `main()`, add to parser BEFORE `args = parser.parse_args()`):
```python
parser.add_argument(
    '--transits',
    metavar='SLUG',
    help='Calculate transits for an existing chart profile (e.g., albert-einstein)'
)
parser.add_argument(
    '--query-date',
    type=valid_query_date,
    default=None,
    help='Date for transit calculation YYYY-MM-DD (default: current UTC time)'
)
```

**Routing in `main()`** — Add transit check AFTER `--list` check and BEFORE natal name validation. Follow the exact same early-return pattern as `--list`:
```python
# Handle --transits flag (MUST come before natal validation)
if args.transits:
    return calculate_transits(args)
```

This ensures `--transits` does not trigger natal chart argument validation (no need for --date, --time, location args when doing transits).
  </action>
  <verify>
Run syntax check:
```bash
source /c/NEW/backend/venv/Scripts/activate && python -c "import ast; ast.parse(open('/c/NEW/backend/astrology_calc.py').read()); print('Syntax OK')"
```

Then verify imports work:
```bash
/c/NEW/backend/venv/Scripts/python -c "from kerykeion.aspects.aspects_factory import AspectsFactory; from kerykeion.house_comparison.house_comparison_factory import HouseComparisonFactory; from kerykeion.schemas.kr_models import ActiveAspect; print('All imports OK')"
```

Then verify help text shows new flags:
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --help
```
Output should show `--transits SLUG` and `--query-date` arguments.

Verify existing --list mode still works:
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --list
```
  </verify>
  <done>
Four new functions added to astrology_calc.py: valid_query_date, load_natal_profile, build_transit_json, calculate_transits. Two new CLI arguments (--transits, --query-date) are registered. Transit routing in main() fires before natal validation. All existing natal chart functionality unchanged. Syntax and imports validated.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end transit calculation verification</name>
  <files>backend/astrology_calc.py</files>
  <action>
Run the transit calculation against an existing natal chart profile to verify all 5 TRAN requirements produce correct output.

First, confirm at least one profile exists:
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --list
```

If no profiles exist, create a test profile first:
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py "Albert Einstein" --date 1879-03-14 --time 11:30 --lat 48.4011 --lng 9.9876 --tz "Europe/Berlin" --force
```

Then run transit calculation with default date (today):
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits albert-einstein
```

And with a specific query date:
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits albert-einstein --query-date 2026-03-20
```

**Verify the JSON output contains all required fields:**
1. TRAN-01: `meta.query_date` matches the requested date, `transit_planets` has exactly 10 entries with name/sign/degree/abs_position
2. TRAN-02: `transit_aspects` entries have aspect/orb fields, `meta.orbs_used` shows the default orb configuration
3. TRAN-03: Each entry in `transit_planets` has `natal_house` (integer 1-12)
4. TRAN-04: Each entry in `transit_planets` has `retrograde` (boolean)
5. TRAN-05: Each entry in `transit_aspects` has `applying` (boolean) and `movement` (string: Applying/Separating/Static)

**Verify error handling:**
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits nonexistent-profile
```
Should exit with code 1 and print error to stderr.

```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits albert-einstein --query-date 1850-01-01
```
Should reject date outside 1900-2100 range.

**Verify natal chart creation still works (regression check):**
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py "Test Regression" --date 1990-06-15 --time 14:30 --lat 51.5074 --lng -0.1278 --tz "Europe/London" --force
```
Should complete successfully with full natal chart output.

If ANY verification fails, fix the issue in astrology_calc.py before marking done. Common fixes:
- If `dual_chart_aspects` raises TypeError: check `active_aspects` parameter type (must be list of ActiveAspect TypedDict, orb must be int not float)
- If `natal_house` is None: check HouseComparisonFactory point name mapping matches planet names exactly
- If transit positions look wrong: verify UTC timezone is used for transit subject
  </action>
  <verify>
All five commands above must succeed:
1. `--transits albert-einstein` → valid JSON with 10 planets and aspects array
2. `--transits albert-einstein --query-date 2026-03-20` → valid JSON with query_date "2026-03-20"
3. `--transits nonexistent-profile` → exit code 1, error message
4. `--transits ... --query-date 1850-01-01` → argument error (out of range)
5. Natal chart creation with "Test Regression" → full natal output, no errors

Pipe transit output through python JSON validation:
```bash
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits albert-einstein | /c/NEW/backend/venv/Scripts/python -c "import json,sys; d=json.load(sys.stdin); assert len(d['transit_planets'])==10; assert 'transit_aspects' in d; assert all('natal_house' in p for p in d['transit_planets']); assert all('retrograde' in p for p in d['transit_planets']); assert all('applying' in a for a in d['transit_aspects']); print(f'PASS: {len(d[\"transit_planets\"])} planets, {len(d[\"transit_aspects\"])} aspects')"
```
  </verify>
  <done>
Transit snapshot calculation works end-to-end against a real natal chart profile. JSON output contains all 5 TRAN requirement fields: transit positions (TRAN-01), aspects with orbs (TRAN-02), natal house placement (TRAN-03), retrograde status (TRAN-04), applying/separating movement (TRAN-05). Error handling rejects missing profiles and invalid dates. Natal chart creation regression test passes.
  </done>
</task>

</tasks>

<verification>
Phase 7 is complete when all 5 success criteria from ROADMAP.md are satisfied:
1. User can calculate transit positions for any date against a natal chart profile → `--transits SLUG` with optional `--query-date`
2. User can see transit-to-natal aspects with configurable orbs → `transit_aspects` array with default orbs 3/3/2/2/1
3. User can see which natal houses transiting planets occupy → `natal_house` field in each transit planet entry
4. User can see retrograde status for each transiting planet → `retrograde` boolean in each transit planet entry
5. User can see whether each transit aspect is applying or separating → `applying` boolean and `movement` string in each aspect entry
</verification>

<success_criteria>
- `--transits albert-einstein` produces valid JSON with 10 transit planets and an aspects array
- `--transits albert-einstein --query-date 2026-03-20` uses the specified date
- Each transit planet entry has: name, sign, degree, abs_position, retrograde, natal_house
- Each transit aspect entry has: transit_planet, natal_planet, aspect, orb, applying, movement
- `--transits nonexistent-slug` exits with code 1 and error message
- `--query-date 1850-01-01` rejects dates outside 1900-2100 range
- Existing natal chart creation and --list modes still work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-current-transit-snapshots/07-01-SUMMARY.md`
</output>
