---
phase: 08-transit-timelines
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/astrology_calc.py
autonomous: true

must_haves:
  truths:
    - "User can generate a transit timeline with --timeline SLUG --range week (and 30d, 3m, year presets)"
    - "User can generate a transit timeline with --timeline SLUG --start YYYY-MM-DD --end YYYY-MM-DD"
    - "User can see exact transit aspect hit events sorted chronologically with date, transit planet, aspect type, natal planet, and orb"
    - "Existing --transits, --list, and natal chart creation modes continue working unchanged"
  artifacts:
    - path: "backend/astrology_calc.py"
      provides: "Timeline functions, CLI arguments, and main() routing"
      contains: "def calculate_timeline"
  key_links:
    - from: "main()"
      to: "calculate_timeline(args)"
      via: "args.timeline check before args.transits check"
      pattern: "if args\\.timeline"
    - from: "calculate_timeline()"
      to: "load_natal_profile()"
      via: "function call to load natal subject and data"
      pattern: "load_natal_profile\\(args\\.timeline\\)"
    - from: "calculate_timeline()"
      to: "EphemerisDataFactory + TransitsTimeRangeFactory"
      via: "Kerykeion factory pipeline for daily transit computation"
      pattern: "EphemerisDataFactory|TransitsTimeRangeFactory"
    - from: "build_timeline_events()"
      to: "TransitsTimeRangeModel.transits"
      via: "Applying->Separating transition detection for exact hits"
      pattern: "aspect_movement.*Applying.*Separating"
---

<objective>
Add transit timeline generation to the CLI via `--timeline SLUG` with preset ranges (week, 30d, 3m, year) and custom date ranges (--start/--end). Uses Kerykeion EphemerisDataFactory + TransitsTimeRangeFactory to compute daily transit aspects, then extracts exact hit events (Applying->Separating transitions) into a chronological JSON output.

Purpose: Enables users to see when specific transit aspects perfect over a date range, providing the temporal dimension that single-day transit snapshots (Phase 7) lack.
Output: Updated `backend/astrology_calc.py` with timeline functionality (4 new functions, 4 new CLI args, main() routing).
</objective>

<execution_context>
@C:/Users/faisa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/faisa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-transit-timelines/08-RESEARCH.md
@.planning/phases/07-current-transit-snapshots/07-01-SUMMARY.md
@backend/astrology_calc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeline functions, CLI arguments, and main() routing</name>
  <files>backend/astrology_calc.py</files>
  <action>
Add 2 new imports at the top of the file (after existing kerykeion imports):
```python
from kerykeion.ephemeris_data_factory import EphemerisDataFactory
from kerykeion.transits_time_range_factory import TransitsTimeRangeFactory
```

Also add `timedelta` to the existing `from datetime import datetime, timezone` line:
```python
from datetime import datetime, timezone, timedelta
```

Also add `defaultdict` import:
```python
from collections import defaultdict
```

Add 4 new functions AFTER `calculate_transits()` and BEFORE `position_to_sign_degree()`. Place them in this order:

**1. `parse_preset_range(preset, reference_date=None)`**
- Converts preset string ('week', '30d', '3m', 'year') to (start_dt, end_dt) tuple at UTC noon
- Uses timedelta with fixed deltas: week=6d, 30d=29d, 3m=89d, year=364d (inclusive day counts)
- If reference_date is None, uses current UTC date
- Raises ValueError for invalid preset strings
- See 08-RESEARCH.md Pattern 3 for exact implementation

**2. `build_timeline_events(results)`**
- Takes TransitsTimeRangeModel from TransitsTimeRangeFactory.get_transit_moments()
- Uses defaultdict(list) to track per (transit_planet, aspect, natal_planet) tuples with (date, orb, movement)
- Only tracks aspects where BOTH p1_name and p2_name are in MAJOR_PLANETS
- Scans consecutive pairs for Applying -> Separating (or Static) transitions
- Reports the Applying day as the hit date with its orb
- Returns sorted list of event dicts: {date, transit_planet, aspect, natal_planet, orb_at_hit}
- See 08-RESEARCH.md Pattern 2 for exact implementation

**3. `build_timeline_json(results, natal_data, slug, start_dt, end_dt)`**
- Calls build_timeline_events(results) to get events list
- Assembles complete timeline JSON dict with two top-level keys:
  - "meta": natal_name (from natal_data["meta"]["name"]), natal_slug, start_date (YYYY-MM-DD), end_date (YYYY-MM-DD), range_days (integer delta), chart_type="transit_timeline", calculated_at (UTC ISO), orbs_used (dict from TRANSIT_DEFAULT_ORBS), event_count, sampling_note="Daily resolution; fast Moon aspects (< 4h in orb) may not appear."
  - "events": the sorted events list from build_timeline_events
- See 08-RESEARCH.md Pattern 5 for target output structure

**4. `calculate_timeline(args)`**
- Orchestrates the full pipeline:
  1. Calls load_natal_profile(args.timeline) to get (natal_subject, natal_data)
  2. Determines date range: if args.start AND args.end set, use them (custom range, TRAN-07). If only one is set, print error to stderr and return 1. Otherwise use parse_preset_range(args.range) for preset (TRAN-06).
  3. Validates custom range: start < end, and range <= 365 days. Print clear error to stderr and return 1 if violated.
  4. Creates EphemerisDataFactory with start_datetime=start_dt, end_datetime=end_dt, step_type='days', step=1, lat=0.0, lng=0.0, tz_str='Etc/UTC'
  5. Gets ephemeris subjects via .get_ephemeris_data_as_astrological_subjects()
  6. Creates TransitsTimeRangeFactory with natal_chart=natal_subject, ephemeris_data_points=ephemeris_subjects, active_points=MAJOR_PLANETS, active_aspects=TRANSIT_DEFAULT_ORBS
  7. Gets results via .get_transit_moments()
  8. Calls build_timeline_json(results, natal_data, args.timeline, start_dt, end_dt)
  9. Prints JSON to stdout with indent=2
  10. Returns 0 on success
- Wraps entire body in try/except: FileNotFoundError, ValueError, generic Exception — all print to stderr and return 1
- See 08-RESEARCH.md "Complete Pipeline" code example for full implementation

Add 4 new CLI arguments in main() parser section, AFTER the --query-date argument block and BEFORE `args = parser.parse_args()`:

```python
parser.add_argument(
    '--timeline',
    metavar='SLUG',
    help='Generate transit timeline for an existing chart profile (e.g., albert-einstein)'
)
parser.add_argument(
    '--range',
    choices=['week', '30d', '3m', 'year'],
    default='30d',
    help='Preset date range for timeline (default: 30d). Ignored if --start/--end given.'
)
parser.add_argument(
    '--start',
    type=valid_query_date,
    default=None,
    help='Custom timeline start date YYYY-MM-DD (requires --end)'
)
parser.add_argument(
    '--end',
    type=valid_query_date,
    default=None,
    help='Custom timeline end date YYYY-MM-DD (requires --start)'
)
```

Add timeline routing in main() AFTER the `--list` check and BEFORE the `--transits` check:
```python
# Handle --timeline flag (MUST come before --transits and natal validation)
if args.timeline:
    return calculate_timeline(args)
```

IMPORTANT constraints:
- Do NOT modify any existing functions (load_natal_profile, build_transit_json, calculate_transits, etc.)
- Use lat=0.0, lng=0.0, tz_str='Etc/UTC' for EphemerisDataFactory (NOT natal chart location)
- Always pass TRANSIT_DEFAULT_ORBS and MAJOR_PLANETS explicitly to TransitsTimeRangeFactory
- Reuse valid_query_date for --start/--end validation (already handles 1900-2100 range)
  </action>
  <verify>
Run all three modes to confirm no regressions and new functionality works:

```bash
# 1. Verify existing --list mode still works
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --list

# 2. Verify --timeline with default 30d preset (requires an existing profile)
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline albert-einstein

# 3. Verify --timeline with week preset
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline albert-einstein --range week

# 4. Verify --timeline with custom date range
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline albert-einstein --start 2026-03-01 --end 2026-04-01

# 5. Verify error: --start without --end
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline albert-einstein --start 2026-03-01

# 6. Verify error: --start >= --end
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline albert-einstein --start 2026-04-01 --end 2026-03-01

# 7. Verify error: non-existent profile
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline nonexistent-person

# 8. Verify --help shows new arguments
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --help
```

All commands should exit with expected codes (0 for success, 1 for validation errors, 2 for argparse errors).
  </verify>
  <done>
- `--timeline SLUG` with `--range week/30d/3m/year` outputs chronological JSON timeline with meta and events sections
- `--timeline SLUG` with `--start` and `--end` outputs the same JSON format for custom date ranges
- Events list contains exact aspect hit dicts with date, transit_planet, aspect, natal_planet, orb_at_hit
- Meta section includes sampling_note about Moon daily resolution limitation
- Validation errors (missing --end, start >= end, range > 365 days, missing profile) print to stderr and exit 1
- Existing --transits, --list, and natal creation modes are completely unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end timeline verification across all preset ranges</name>
  <files>backend/astrology_calc.py</files>
  <action>
Run comprehensive verification of the timeline feature. This task produces no code changes — it validates Task 1 output.

**Verification matrix:**

1. **Preset range: week** — Run `--timeline albert-einstein --range week`. Verify:
   - JSON output has "meta.range_days" close to 7
   - "meta.chart_type" is "transit_timeline"
   - "meta.sampling_note" is present
   - "events" is a list (may be empty for short range)
   - Each event has all 5 fields: date, transit_planet, aspect, natal_planet, orb_at_hit

2. **Preset range: year** — Run `--timeline albert-einstein --range year`. Verify:
   - JSON output has "meta.range_days" close to 365
   - "events" list has multiple entries (expect 50-200+ for a year)
   - Events are sorted chronologically (each date >= previous date)
   - orb_at_hit values are all <= 3.0 (within TRANSIT_DEFAULT_ORBS maximum)

3. **Custom range** — Run `--timeline albert-einstein --start 2026-06-01 --end 2026-09-01`. Verify:
   - "meta.start_date" is "2026-06-01"
   - "meta.end_date" is "2026-09-01"
   - Events fall within the specified date range

4. **Error cases** — Verify each returns exit code 1 with error on stderr:
   - `--timeline albert-einstein --start 2026-01-01` (missing --end)
   - `--timeline albert-einstein --start 2026-06-01 --end 2026-01-01` (start >= end)
   - `--timeline nonexistent-slug` (missing profile)

5. **Regression check** — Run `--transits albert-einstein` and verify it still produces transit snapshot JSON (not timeline JSON). Confirm "chart_type" is "transit_snapshot" (not "transit_timeline").

If any check fails, fix the issue in the implementation before marking done.
  </action>
  <verify>
All 5 verification categories pass. Specific checks:
```bash
# Quick validation: year range produces events
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --timeline albert-einstein --range year 2>&1 | python -c "import sys,json; d=json.load(sys.stdin); print(f'Events: {len(d[\"events\"])}, Range: {d[\"meta\"][\"range_days\"]}d, Type: {d[\"meta\"][\"chart_type\"]}')"

# Regression: transits still work
/c/NEW/backend/venv/Scripts/python /c/NEW/backend/astrology_calc.py --transits albert-einstein 2>&1 | python -c "import sys,json; d=json.load(sys.stdin); print(f'Type: {d[\"meta\"][\"chart_type\"]}')"
```
  </verify>
  <done>
- Week, 30d, 3m, and year presets all produce valid timeline JSON with correct meta and events
- Custom date range produces correctly bounded events
- Error cases return exit code 1 with descriptive stderr messages
- --transits mode is completely unaffected (regression-free)
- Event count for year range is substantial (50+), confirming the pipeline processes correctly
  </done>
</task>

</tasks>

<verification>
1. `--timeline albert-einstein --range 30d` exits 0, outputs JSON with meta.chart_type="transit_timeline" and events array
2. `--timeline albert-einstein --range year` exits 0, events are chronologically sorted with orbs within transit orb limits
3. `--timeline albert-einstein --start 2026-03-01 --end 2026-04-01` exits 0, events fall within date range
4. `--timeline albert-einstein --start 2026-03-01` (no --end) exits 1 with error on stderr
5. `--transits albert-einstein` still produces transit snapshot JSON (chart_type="transit_snapshot")
6. `--list` still works unchanged
7. `--help` shows --timeline, --range, --start, --end arguments
</verification>

<success_criteria>
- All 4 preset ranges (week, 30d, 3m, year) generate valid timeline JSON
- Custom --start/--end ranges generate valid timeline JSON
- Exact hit events detected via Applying->Separating transition, sorted chronologically
- Error handling covers missing --end, start >= end, range > 365 days, missing profile
- Zero regressions to existing --transits, --list, and natal chart creation modes
</success_criteria>

<output>
After completion, create `.planning/phases/08-transit-timelines/08-01-SUMMARY.md`
</output>
